<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA - OneMaxÂïèÈ°å</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            padding: 8px;
            overflow-y: auto;
        }
        
        .container {
            max-width: 1400px;
            min-height: calc(100vh - 16px);
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            font-size: 1.4em;
            margin-bottom: 2px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            flex: 1;
            min-height: 0;
        }
        
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 6px;
            background: #f0f4f8;
            border-radius: 10px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-size: 0.8em;
            font-weight: bold;
            color: #555;
            margin-bottom: 2px;
        }
        
        input[type="number"], input[type="range"] {
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        button {
            padding: 8px 20px;
            font-size: 0.9em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stop-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .stat-card {
            background: white;
            padding: 6px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.7em;
        }
        
        .chart-container {
            background: white;
            padding: 6px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-height: 0;
        }
        
        canvas {
            max-width: 100%;
            max-height: 100%;
        }
        
        .right-panel {
            background: white;
            padding: 6px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            height: 620px;
        }
        
        .population-title {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
        }
        
        .individual {
            display: inline-flex;
            margin: 2px;
            padding: 3px;
            background: #f0f0f0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8em;
            align-items: center;
        }
        
        .best-individual {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            font-weight: bold;
        }
        
        .gene {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 0.75em;
        }
        
        .gene-0 {
            background: #ff6b6b;
            color: white;
        }
        
        .gene-1 {
            background: #4ecdc4;
            color: white;
        }
        
        .fitness-badge {
            margin-left: 5px;
            padding: 2px 6px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .index-badge {
            margin-right: 6px;
            padding: 2px 6px;
            background: #94a3b8; /* slate */
            color: white;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.75em;
            
            text-align: center;
        }
    .about {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        padding: 8px 10px;
        font-size: 0.9em;
        line-height: 1.5;
        margin-top: 6px;
    }
    .about h2 {
        font-size: 1em;
        margin-bottom: 6px;
        color: #333;
    }
    .about dl {
        display: grid;
        grid-template-columns: 7em 1fr;
        gap: 4px 10px;
    }
    .about dt {
        font-weight: bold;
        color: #555;
    }
    .about dd {
        margin: 0;
        color: #444;
    }
    .about ul {
        margin-left: 1.2em;
    }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß¨ ÈÅ∫‰ºùÁöÑ„Ç¢„É´„Ç¥„É™„Ç∫„É† - OneMaxÂïèÈ°å</h1>
        
        <div class="main-content">
            <div class="left-panel">
                <div class="controls">
                    <div class="control-group">
                        <label for="geneLength">ÈÅ∫‰ºùÂ≠êÈï∑</label>
                        <input type="number" id="geneLength" value="20" min="5" max="50">
                    </div>
                    <div class="control-group">
                        <label for="populationSize">ÂÄã‰ΩìÊï∞</label>
                        <input type="number" id="populationSize" value="20" min="10" max="100">
                    </div>
                    <div class="control-group">
                        <label for="mutationRate">Á™ÅÁÑ∂Â§âÁï∞Áéá: <span id="mutationRateValue">0.01</span></label>
                        <input type="range" id="mutationRate" value="0.01" min="0" max="0.1" step="0.001">
                    </div>
                    <div class="control-group">
                        <label for="crossoverRate">‰∫§ÂèâÁéá: <span id="crossoverRateValue">0.8</span></label>
                        <input type="range" id="crossoverRate" value="0.8" min="0" max="1" step="0.01">
                    </div>
                    <div class="control-group">
                        <label for="tournamentSize">„Éà„Éº„Éä„É°„É≥„Éà„Çµ„Ç§„Ç∫</label>
                        <input type="number" id="tournamentSize" value="3" min="2" max="20">
                    </div>
                    <div class="control-group">
                        <label for="eliteSize">„Ç®„É™„Éº„ÉàÊï∞</label>
                        <input type="number" id="eliteSize" value="2" min="0" max="10">
                    </div>
                    <div class="control-group">
                        <label for="maxGenerations">Êâì„Å°Âàá„Çä‰∏ñ‰ª£</label>
                        <input type="number" id="maxGenerations" value="30" min="1" max="10000">
                    </div>
                    <div class="control-group">
                        <label for="speed">„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÄüÂ∫¶</label>
                        <input type="range" id="speed" value="5" min="1" max="10" step="1">
                        <span id="speedValue">5</span>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="start-btn" id="playBtn" onclick="toggleRun()">ÈñãÂßã</button>
                    <button class="reset-btn" onclick="resetGA()">„É™„Çª„ÉÉ„Éà/ÂàùÊúüÂåñ</button>
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="generation">0</div>
                        <div class="stat-label">‰∏ñ‰ª£</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bestFitness">0</div>
                        <div class="stat-label">ÊúÄÈ´òÈÅ©ÂøúÂ∫¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgFitness">0</div>
                        <div class="stat-label">Âπ≥ÂùáÈÅ©ÂøúÂ∫¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="diversity">0%</div>
                        <div class="stat-label">Â§öÊßòÊÄß</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="fitnessChart"></canvas>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="population-title">ÁèæÂú®„ÅÆÂÄã‰ΩìÁæ§Ôºà‰∏ä‰Ωç20ÂÄã‰ΩìÔºâ</div>
                <div id="individuals"></div>
            </div>
        </div>
        <section class="about">
            <h2>„Åì„ÅÆ„Éá„É¢„ÅÆË™¨Êòé</h2>
            <dl>
                <dt>ÁõÆÁöÑ</dt>
                <dd>OneMaxÂïèÈ°åÔºà0/1ÈÅ∫‰ºùÂ≠êÂàó„Å´„Åä„ÅÑ„Å¶„Äå1„Äç„ÅÆÂÄãÊï∞„ÇíÊúÄÂ§ßÂåñ„Åô„ÇãÂïèÈ°åÔºâ„ÇíÈÅ∫‰ºùÁöÑ„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÅßËß£„ÅèÊßòÂ≠ê„ÇíÂèØË¶ñÂåñ„Åô„Çã„ÇÇ„ÅÆ„Åß„ÅÇ„ÇãÔºé</dd>
                <dt>ÈÅ©ÂøúÂ∫¶</dt>
                <dd>ÈÅ©ÂøúÂ∫¶„ÅØÈÅ∫‰ºùÂ≠êÂàó‰∏≠„ÅÆ1„ÅÆÁ∑èÊï∞„Åß„ÅÇ„ÇãÔºéÊúÄÈ´òÈÅ©ÂøúÂ∫¶„ÅåÈÅ∫‰ºùÂ≠êÈï∑„Å´Á≠â„Åó„Åè„Å™„Å£„ÅüÊôÇÁÇπ„ÅßÊúÄÈÅ©Ëß£„Å´Âà∞ÈÅî„Åó„Åü„Åì„Å®„ÇíÊÑèÂë≥„Åô„ÇãÔºé</dd>
                <dt>ÈÄ≤Âåñ„ÅÆÊµÅ„Çå</dt>
                <dd>ÂàùÊúüÂåñ ‚Üí Ë©ï‰æ° ‚Üí ÈÅ∏ÊäûÔºà„Éà„Éº„Éä„É°„É≥„ÉàÔºâ‚Üí ‰∫§ÂèâÔºà2ÁÇπÔºâ‚Üí Á™ÅÁÑ∂Â§âÁï∞ ‚Üí „Ç®„É™„Éº„Éà‰øùÊåÅ ‚Üí ‰∏ñ‰ª£Êõ¥Êñ∞Ôºå„ÇíÁπ∞„ÇäËøî„ÅôÔºé</dd>
                <dt>ÂÅúÊ≠¢Êù°‰ª∂</dt>
                <dd>
                    „ÅÑ„Åö„Çå„Åã„ÇíÊ∫Ä„Åü„Åô„Å®ÂÅúÊ≠¢„Åô„ÇãÔºé
                    <ul>
                        <li>ÊúÄÈ´òÈÅ©ÂøúÂ∫¶„ÅåÈÅ∫‰ºùÂ≠êÈï∑„Å´Âà∞ÈÅî„Åó„Åü„Å®„ÅçÔºé</li>
                        <li>Êâì„Å°Âàá„Çä‰∏ñ‰ª£„ÅßÊåáÂÆö„Åó„Åü‰∏ñ‰ª£Êï∞„Å´Âà∞ÈÅî„Åó„Åü„Å®„ÅçÔºé</li>
                    </ul>
                </dd>
                <dt>Â§öÊßòÊÄß</dt>
                <dd>ÂÄã‰ΩìÁæ§ÂÜÖ„ÅÆ„É¶„Éã„Éº„ÇØ„Å™ÈÅ∫‰ºùÂ≠êÂàó„ÅÆÂâ≤Âêà„ÇíÔºÖ„ÅßË°®Á§∫„Åó„Å¶„ÅÑ„ÇãÔºéÂÄ§„Åå‰Ωé‰∏ã„ÅóÈÅé„Åé„Çã„Å®Êó©ÊúüÂèéÊùü„ÅÆÂÖÜÂÄô„Å®„Å™„Çã„Åì„Å®„Åå„ÅÇ„ÇãÔºéË®àÁÆóÂºè„ÅØ<code>(„É¶„Éã„Éº„ÇØ„Å™ÈÅ∫‰ºùÂ≠ê„ÅÆÁ®ÆÈ°û„ÅÆÊï∞ / Á∑èÂÄã‰ΩìÊï∞) * 100</code>„Åß„ÅôÔºé</dd>
                <dt>Êìç‰Ωú</dt>
                <dd>
                    <ul>
                        <li><strong>ÈÅ∫‰ºùÂ≠êÈï∑„ÉªÂÄã‰ΩìÊï∞„Éª„Ç®„É™„Éº„ÉàÊï∞</strong>ÔºöÂïèÈ°åË¶èÊ®°„Å®ÈÅ∏ÊäûÂúß„ÇíË™øÊï¥„Åô„ÇãÔºé</li>
                        <li><strong>‰∫§ÂèâÁéá„ÉªÁ™ÅÁÑ∂Â§âÁï∞Áéá</strong>ÔºöÊé¢Á¥¢„ÅÆÈõÜÁ¥Ñ„Å®Êã°Êï£„ÅÆ„Éê„É©„É≥„Çπ„ÇíÂà∂Âæ°„Åô„ÇãÔºé</li>
                        <li><strong>Êâì„Å°Âàá„Çä‰∏ñ‰ª£</strong>ÔºöÊúÄÂ§ß‰∏ñ‰ª£Êï∞„ÇíÊåáÂÆö„Åô„ÇãÔºà„Éá„Éï„Ç©„É´„Éà30ÔºâÔºé</li>
                        <li><strong>„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÄüÂ∫¶</strong>ÔºöÂ§ß„Åç„ÅÑ„Åª„Å©È´òÈÄü„ÅßË°®Á§∫Êõ¥Êñ∞„Åô„ÇãÔºé</li>
                        <li><strong>„É™„Çª„ÉÉ„Éà/ÂàùÊúüÂåñ</strong>ÔºöÊØéÂõû„É©„É≥„ÉÄ„É†„Å´ÂàùÊúüÂÄã‰ΩìÁæ§„ÇíÂÜçÁîüÊàê„Åó„Å¶Ë°®Á§∫„Åô„ÇãÔºé</li>
                    </ul>
                </dd>
            </dl>
        </section>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let ga = null;
        let chart = null;
        let isRunning = false;
        let animationId = null;

        function updatePlayLabel() {
            const btn = document.getElementById('playBtn');
            if (!btn) return;
            if (!ga) {
                btn.textContent = 'ÈñãÂßã';
            } else if (isRunning) {
                btn.textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';
            } else {
                btn.textContent = 'ÂÜçÁîü';
            }
        }
        
        document.getElementById('mutationRate').addEventListener('input', (e) => {
            document.getElementById('mutationRateValue').textContent = e.target.value;
        });
        
        document.getElementById('crossoverRate').addEventListener('input', (e) => {
            document.getElementById('crossoverRateValue').textContent = e.target.value;
        });
        
        document.getElementById('speed').addEventListener('input', (e) => {
            document.getElementById('speedValue').textContent = e.target.value;
        });
        
        class GeneticAlgorithm {
            constructor(geneLength, populationSize, mutationRate, crossoverRate, eliteSize) {
                this.geneLength = geneLength;
                this.populationSize = populationSize;
                this.mutationRate = mutationRate;
                this.crossoverRate = crossoverRate;
                this.eliteSize = eliteSize;
                this.tournamentSize = parseInt(document.getElementById('tournamentSize').value);
                this.generation = 0;
                this.population = this.initializePopulation();
                this.bestIndividual = null;
                this.fitnessHistory = [];
                this.avgFitnessHistory = [];
                this.maxGenerations = parseInt(document.getElementById('maxGenerations').value);
            }
            
            initializePopulation() {
                const population = [];
                for (let i = 0; i < this.populationSize; i++) {
                    const individual = [];
                    for (let j = 0; j < this.geneLength; j++) {
                        individual.push(Math.random() < 0.5 ? 0 : 1);
                    }
                    population.push(individual);
                }
                return population;
            }
            
            fitness(individual) {
                return individual.reduce((sum, gene) => sum + gene, 0);
            }
            
            selection() {
                const tournamentSize = this.tournamentSize;
                const tournament = [];
                for (let i = 0; i < tournamentSize; i++) {
                    const randomIndex = Math.floor(Math.random() * this.population.length);
                    tournament.push(this.population[randomIndex]);
                }
                return tournament.reduce((best, current) =>
                    this.fitness(current) > this.fitness(best) ? current : best
                );
            }
            
            crossover(parent1, parent2) {
                if (Math.random() > this.crossoverRate) {
                    return [parent1.slice(), parent2.slice()];
                }
                
                const point1 = Math.floor(Math.random() * this.geneLength);
                const point2 = Math.floor(Math.random() * this.geneLength);
                const start = Math.min(point1, point2);
                const end = Math.max(point1, point2);
                
                const child1 = [];
                const child2 = [];
                
                for (let i = 0; i < this.geneLength; i++) {
                    if (i >= start && i <= end) {
                        child1.push(parent2[i]);
                        child2.push(parent1[i]);
                    } else {
                        child1.push(parent1[i]);
                        child2.push(parent2[i]);
                    }
                }
                
                return [child1, child2];
            }
            
            mutate(individual) {
                const mutated = individual.slice();
                for (let i = 0; i < this.geneLength; i++) {
                    if (Math.random() < this.mutationRate) {
                        mutated[i] = 1 - mutated[i];
                    }
                }
                return mutated;
            }
            
            evolve() {
                this.population.sort((a, b) => this.fitness(b) - this.fitness(a));
                
                const newPopulation = [];
                for (let i = 0; i < this.eliteSize && i < this.population.length; i++) {
                    newPopulation.push(this.population[i].slice());
                }
                
                while (newPopulation.length < this.populationSize) {
                    const parent1 = this.selection();
                    const parent2 = this.selection();
                    const [child1, child2] = this.crossover(parent1, parent2);
                    newPopulation.push(this.mutate(child1));
                    if (newPopulation.length < this.populationSize) {
                        newPopulation.push(this.mutate(child2));
                    }
                }
                
                this.population = newPopulation.slice(0, this.populationSize);
                this.generation++;
                
                const fitnesses = this.population.map(ind => this.fitness(ind));
                const maxFitness = Math.max(...fitnesses);
                const avgFitness = fitnesses.reduce((a, b) => a + b, 0) / fitnesses.length;
                
                this.fitnessHistory.push(maxFitness);
                this.avgFitnessHistory.push(avgFitness);
                
                this.bestIndividual = this.population[0];
                
                return {
                    generation: this.generation,
                    bestFitness: maxFitness,
                    avgFitness: avgFitness.toFixed(1),
                    diversity: this.calculateDiversity(),
                    maxGenerations: this.maxGenerations
                };
            }
            
            calculateDiversity() {
                const uniqueIndividuals = new Set(this.population.map(ind => ind.join('')));
                return (((uniqueIndividuals.size - 1) / (this.population.length - 1)) * 100).toFixed(0);
            }

            // Return current stats without evolving
            getStats() {
                const fitnesses = this.population.map(ind => this.fitness(ind));
                const maxFitness = Math.max(...fitnesses);
                const avgFitness = fitnesses.reduce((a, b) => a + b, 0) / fitnesses.length;
                return {
                    generation: this.generation,
                    bestFitness: maxFitness,
                    avgFitness: avgFitness.toFixed(1),
                    diversity: this.calculateDiversity(),
                    maxGenerations: this.maxGenerations
                };
            }
        }
        
        function initChart() {
            const ctx = document.getElementById('fitnessChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ÊúÄÈ´ò',
                        data: [],
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0,
                        borderWidth: 2,
                        pointRadius: 0
                    }, {
                        label: 'Âπ≥Âùá',
                        data: [],
                        borderColor: 'rgb(255, 107, 107)',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0,
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                padding: 5,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    elements: {
                        line: {
                            tension: 0
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '‰∏ñ‰ª£Êï∞'
                            },
                            ticks: {
                                font: {
                                    size: 9
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ÈÅ©ÂøúÂ∫¶'
                            },
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 9
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateDisplay(stats) {
            document.getElementById('generation').textContent = stats.generation;
            document.getElementById('bestFitness').textContent = stats.bestFitness;
            document.getElementById('avgFitness').textContent = stats.avgFitness;
            document.getElementById('diversity').textContent = stats.diversity + '%';
            
            chart.data.labels.push(stats.generation);
            chart.data.datasets[0].data.push(stats.bestFitness);
            chart.data.datasets[1].data.push(stats.avgFitness);
            
            const maxPoints = 30;
            if (chart.data.labels.length > maxPoints) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }
            
            chart.update();
            displayPopulation();
        }
        
        function displayPopulation() {
            const container = document.getElementById('individuals');
            container.innerHTML = '';
            
            const sorted = [...ga.population].sort((a, b) => ga.fitness(b) - ga.fitness(a));
            const maxFitness = ga.fitness(sorted[0]);
            
            sorted.slice(0, 20).forEach((individual, index) => {
                const fitness = ga.fitness(individual);
                const isMax = fitness === maxFitness && index === 0;
                
                const div = document.createElement('div');
                div.className = isMax ? 'individual best-individual' : 'individual';
                
                // Add index badge
            const idx = document.createElement('div');
            idx.className = 'index-badge';
            idx.textContent = 'index ' + String(index + 1).padStart(2, '0');
            div.appendChild(idx);
                
                individual.forEach(gene => {
                    const geneDiv = document.createElement('div');
                    geneDiv.className = `gene gene-${gene}`;
                    geneDiv.textContent = gene;
                    div.appendChild(geneDiv);
                });
                
                const fitnessDiv = document.createElement('div');
                fitnessDiv.className = 'fitness-badge';
                fitnessDiv.textContent = fitness;
                div.appendChild(fitnessDiv);
                
                container.appendChild(div);
            });
        }
        
        function startGA() {
            if (isRunning) return;

            if (!ga) {
                const geneLength = parseInt(document.getElementById('geneLength').value);
                const populationSize = parseInt(document.getElementById('populationSize').value);
                const mutationRate = parseFloat(document.getElementById('mutationRate').value);
                const crossoverRate = parseFloat(document.getElementById('crossoverRate').value);
                const eliteSize = parseInt(document.getElementById('eliteSize').value);
                ga = new GeneticAlgorithm(geneLength, populationSize, mutationRate, crossoverRate, eliteSize);

                if (!chart) {
                    initChart();
                }
            }

            isRunning = true;
            updatePlayLabel();
            const speedLevel = parseInt(document.getElementById('speed').value);
            const speed = 1000 / speedLevel; // higher speedLevel = shorter delay

            function run() {
                if (!isRunning) return;

                const stats = ga.evolve();
                updateDisplay(stats);

                if (stats.generation >= ga.maxGenerations) {
                    stopGA();
                    return;
                }

                animationId = setTimeout(run, speed);
            }

            run();
        }
        
        function stopGA() {
            isRunning = false;
            if (animationId) {
                clearTimeout(animationId);
                animationId = null;
            }
            updatePlayLabel();
        }

        function toggleRun() {
            if (isRunning) {
                // pause
                isRunning = false;
                if (animationId) {
                    clearTimeout(animationId);
                    animationId = null;
                }
                updatePlayLabel();
                return;
            }
            // start or resume
            // If already finished, do nothing (user can reset to start anew)
            if (ga && ga.generation >= ga.maxGenerations) {
                return;
            }
            startGA(); // handles both first start and resume
            updatePlayLabel();
        }
        
        function resetGA() {
            stopGA();
            // Recreate GA with current control values (random re-initialization every time)
            const geneLength = parseInt(document.getElementById('geneLength').value);
            const populationSize = parseInt(document.getElementById('populationSize').value);
            const mutationRate = parseFloat(document.getElementById('mutationRate').value);
            const crossoverRate = parseFloat(document.getElementById('crossoverRate').value);
            const eliteSize = parseInt(document.getElementById('eliteSize').value);
            ga = new GeneticAlgorithm(geneLength, populationSize, mutationRate, crossoverRate, eliteSize);

            // Reset chart
            if (chart) {
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.data.datasets[1].data = [];
                chart.update();
            }

            // Show initial stats and population immediately
            const stats = ga.getStats();
            updateDisplay(stats);
            updatePlayLabel();
        }
        
        window.addEventListener('load', () => {
            initChart();
            updatePlayLabel();
        });
    </script>
</body>
</html>
</script>
</body>
</html>
