<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒœã‚¤ãƒ‰ãƒ¢ãƒ‡ãƒ« Ã— æ‰‹ã®å‹•ã - é­šã®ç¾¤ã‚Œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #001a33 0%, #003d5c 50%, #004d73 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
        }

        .container {
            max-width: 1200px;
            width: 100%;
        }

        .status-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            margin: 5px 10px;
        }

        .status-label {
            font-weight: bold;
            color: rgba(255,255,255,0.7);
        }

        .status-value {
            color: #4ECDC4;
            margin-left: 5px;
        }

        .canvas-container {
            position: relative;
            background: rgba(0, 30, 60, 0.5);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        #mainCanvas {
            display: block;
            width: 100%;
            height: auto;
        }

        video {
            display: none;
        }

        .controls {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            color: white;
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .control-label {
            font-weight: bold;
            min-width: 150px;
        }

        input[type="range"] {
            flex: 1;
            margin: 0 15px;
        }

        .control-value {
            min-width: 50px;
            text-align: right;
            color: #4ECDC4;
        }

        .instructions {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            color: white;
        }

        .instructions h2 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .instructions ul {
            list-style: none;
        }

        .instructions li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .instructions li:before {
            content: "ğŸŸ";
            position: absolute;
            left: 0;
        }

        .fish-type-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fish-type-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fish-color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .fish-type-count {
            font-size: 0.9em;
            color: #4ECDC4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-panel">
            <div class="status-item">
                <span class="status-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
                <span class="status-value" id="status">åˆæœŸåŒ–ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">é­šã®æ•°:</span>
                <span class="status-value" id="fishCount">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ‰‹ã®æ¤œå‡º:</span>
                <span class="status-value" id="handStatus">âŒ</span>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="mainCanvas" width="1200" height="700"></canvas>
            <video id="video" playsinline></video>
        </div>

        <div class="controls">
            <h2>ğŸ® é­šã®ç¨®é¡</h2>
            <div id="fishTypesList"></div>
            <h2 style="margin-top: 20px;">âš™ï¸ å…¨ä½“è¨­å®š</h2>
            <div class="control-row">
                <span class="control-label">é€ƒé¿ç¯„å›²:</span>
                <input type="range" id="avoidRangeSlider" min="50" max="300" value="150" step="10">
                <span class="control-value" id="avoidRangeValue">150</span>
            </div>
            <div class="control-row">
                <span class="control-label">é€ƒé¿å¼·åº¦:</span>
                <input type="range" id="avoidStrengthSlider" min="1" max="10" value="5" step="0.5">
                <span class="control-value" id="avoidStrengthValue">5</span>
            </div>
        </div>

        <div class="instructions">
            <h2>ğŸ“‹ ä½¿ã„æ–¹</h2>
            <ul>
                <li>6ç¨®é¡ãƒ»åˆè¨ˆ200åŒ¹ã®é­šã®ç¾¤ã‚ŒãŒæ³³ã„ã§ã„ã¾ã™</li>
                <li>åŒã˜ç¨®é¡ã®é­šåŒå£«ã§ç¾¤ã‚Œã‚’ä½œã‚Šã¾ã™</li>
                <li>æ‰‹ã®ã²ã‚‰ã‚’é­šã«è¿‘ã¥ã‘ã‚‹ã¨é­šãŒé€ƒã’ã¾ã™</li>
                <li>ä¸¡æ‰‹ã‚’ä½¿ã†ã¨ã‚ˆã‚Šåºƒç¯„å›²ã«å½±éŸ¿ã‚’ä¸ãˆã‚‰ã‚Œã¾ã™</li>
                <li>ãƒãƒ¼ãƒˆPCã§ã‚‚å¿«é©ã«å‹•ä½œã—ã¾ã™</li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <script>
        const mainCanvas = document.getElementById('mainCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const video = document.getElementById('video');
        
        const statusElement = document.getElementById('status');
        const fishCountElement = document.getElementById('fishCount');
        const handStatusElement = document.getElementById('handStatus');

        let hands = null;
        let handPositions = [];
        let boids = [];
        let animationId = null;

        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        let params = {
            fishCount: 80,
            avoidRange: 150,
            avoidStrength: 5,
            separationRange: 25,
            alignmentRange: 50,
            cohesionRange: 50,
            maxSpeed: 3,
            maxForce: 0.1
        };

        // é­šã®ç¨®é¡ã®å®šç¾©
        const fishTypes = [
            {
                name: 'ã‚¯ãƒãƒãƒŸ',
                color: { hue: 20, saturation: 90, lightness: 60 },
                size: { min: 6, max: 16 }, // æ‹¡å¤§
                maxSpeed: 2.5,
                speedVariation: 0.8, // é€Ÿåº¦ã®å¹…
                schoolSize: 30,
                separationRange: 20,
                alignmentRange: 40,
                cohesionRange: 50,
                behaviorType: 'territorial',
                wanderStrength: 0.3
            },
            {
                name: 'ã‚¿ãƒ³ã‚¯',
                color: { hue: 50, saturation: 85, lightness: 55 },
                size: { min: 8, max: 20 }, // æ‹¡å¤§
                maxSpeed: 2.0,
                speedVariation: 1.0,
                schoolSize: 25,
                separationRange: 30,
                alignmentRange: 45,
                cohesionRange: 55,
                behaviorType: 'explorer',
                wanderStrength: 0.5
            },
            {
                name: 'å°å‹é’é­š',
                color: { hue: 200, saturation: 80, lightness: 60 },
                size: { min: 4, max: 12 }, // æ‹¡å¤§
                maxSpeed: 4.0,
                speedVariation: 1.2, // ã‚ˆã‚Šé€Ÿã„ã‚‚ã®ã‚‚
                schoolSize: 50,
                separationRange: 15,
                alignmentRange: 60,
                cohesionRange: 70,
                behaviorType: 'schooling',
                wanderStrength: 0.1
            },
            {
                name: 'ã‚¨ãƒ³ã‚¼ãƒ«ãƒ•ã‚£ãƒƒã‚·ãƒ¥',
                color: { hue: 280, saturation: 70, lightness: 65 },
                size: { min: 10, max: 24 }, // æ‹¡å¤§
                maxSpeed: 2.2,
                speedVariation: 0.6, // ã‚†ã£ãŸã‚Š
                schoolSize: 20,
                separationRange: 35,
                alignmentRange: 50,
                cohesionRange: 60,
                behaviorType: 'graceful',
                wanderStrength: 0.4
            },
            {
                name: 'ãƒã‚ªãƒ³ãƒ†ãƒˆãƒ©',
                color: { hue: 180, saturation: 100, lightness: 50 },
                size: { min: 3, max: 10 }, // æ‹¡å¤§
                maxSpeed: 3.5,
                speedVariation: 1.3, // éå¸¸ã«é€Ÿã„ã‚‚ã®ã‚‚
                schoolSize: 40,
                separationRange: 18,
                alignmentRange: 55,
                cohesionRange: 65,
                behaviorType: 'darting',
                wanderStrength: 0.2
            },
            {
                name: 'ã‚°ãƒƒãƒ”ãƒ¼',
                color: { hue: 320, saturation: 85, lightness: 65 },
                size: { min: 5, max: 14 }, // æ‹¡å¤§
                maxSpeed: 3.0,
                speedVariation: 1.1,
                schoolSize: 35,
                separationRange: 20,
                alignmentRange: 50,
                cohesionRange: 60,
                behaviorType: 'playful',
                wanderStrength: 0.6
            }
        ];

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('avoidRangeSlider').addEventListener('input', (e) => {
            params.avoidRange = parseInt(e.target.value);
            document.getElementById('avoidRangeValue').textContent = params.avoidRange;
        });

        document.getElementById('avoidStrengthSlider').addEventListener('input', (e) => {
            params.avoidStrength = parseFloat(e.target.value);
            document.getElementById('avoidStrengthValue').textContent = params.avoidStrength;
        });

        // é­šã®ç¨®é¡ãƒªã‚¹ãƒˆã‚’å‹•çš„ç”Ÿæˆ
        function createFishTypesList() {
            const listContainer = document.getElementById('fishTypesList');
            listContainer.innerHTML = '';
            
            fishTypes.forEach((fishType, index) => {
                const item = document.createElement('div');
                item.className = 'fish-type-item';
                
                const colorHsl = `hsl(${fishType.color.hue}, ${fishType.color.saturation}%, ${fishType.color.lightness}%)`;
                
                item.innerHTML = `
                    <div class="fish-type-name">
                        <div class="fish-color-indicator" style="background-color: ${colorHsl};"></div>
                        <span>${fishType.name}</span>
                    </div>
                    <span class="fish-type-count">${fishType.schoolSize}åŒ¹</span>
                `;
                
                listContainer.appendChild(item);
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«é­šã®ç¨®é¡ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
        createFishTypesList();

        // ãƒ™ã‚¯ãƒˆãƒ«ã‚¯ãƒ©ã‚¹
        class Vector2D {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }

            add(v) {
                this.x += v.x;
                this.y += v.y;
                return this;
            }

            sub(v) {
                return new Vector2D(this.x - v.x, this.y - v.y);
            }

            mult(n) {
                this.x *= n;
                this.y *= n;
                return this;
            }

            div(n) {
                this.x /= n;
                this.y /= n;
                return this;
            }

            mag() {
                return Math.sqrt(this.x * this.x + this.y * this.y);
            }

            normalize() {
                const m = this.mag();
                if (m > 0) this.div(m);
                return this;
            }

            limit(max) {
                if (this.mag() > max) {
                    this.normalize().mult(max);
                }
                return this;
            }

            setMag(mag) {
                return this.normalize().mult(mag);
            }

            dist(v) {
                const dx = this.x - v.x;
                const dy = this.y - v.y;
                return Math.sqrt(dx * dx + dy * dy);
            }

            copy() {
                return new Vector2D(this.x, this.y);
            }
        }

        // ãƒœã‚¤ãƒ‰ï¼ˆé­šï¼‰ã‚¯ãƒ©ã‚¹
        class Boid {
            constructor(x, y, fishType) {
                this.position = new Vector2D(x, y);
                this.velocity = new Vector2D(
                    Math.random() * 2 - 1,
                    Math.random() * 2 - 1
                );
                this.acceleration = new Vector2D(0, 0);
                
                // é­šã®ç¨®é¡ã”ã¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                this.fishType = fishType;
                this.maxSpeed = fishType.maxSpeed;
                this.maxForce = 0.1;
                this.behaviorType = fishType.behaviorType;
                this.wanderStrength = fishType.wanderStrength;
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªå‹•ãç”¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                this.wanderAngle = Math.random() * Math.PI * 2;
                this.wanderRadius = 25;
                this.wanderDistance = 80;
                this.angleChange = 0.3;
                
                // é­šã®è¦‹ãŸç›®
                this.size = Math.random() * (fishType.size.max - fishType.size.min) + fishType.size.min;
                this.hue = fishType.color.hue + (Math.random() * 20 - 10); // è‰²ã«è‹¥å¹²ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
                this.saturation = fishType.color.saturation;
                this.lightness = fishType.color.lightness;
                
                // å€‹ä½“å·®ï¼ˆé€Ÿåº¦ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¨®é¡ã”ã¨ã«è¨­å®šï¼‰
                const baseVariation = fishType.speedVariation || 1.0;
                this.speedVariation = (0.6 + Math.random() * 0.8) * baseVariation; // 60%~140% Ã— ç¨®é¡ã”ã¨ã®ä¿‚æ•°
            }

            applyForce(force) {
                this.acceleration.add(force);
            }

            // æ‰‹ã‹ã‚‰é€ƒã’ã‚‹è¡Œå‹•
            avoidHands(hands) {
                if (hands.length === 0) return new Vector2D(0, 0);

                let steer = new Vector2D(0, 0);
                let count = 0;

                hands.forEach(hand => {
                    const d = this.position.dist(hand);
                    if (d < params.avoidRange && d > 0) {
                        let diff = this.position.sub(hand);
                        diff.normalize();
                        diff.div(d); // è·é›¢ã«å¿œã˜ã¦å¼·åº¦ã‚’èª¿æ•´
                        steer.add(diff);
                        count++;
                    }
                });

                if (count > 0) {
                    steer.div(count);
                    steer.setMag(this.maxSpeed * params.avoidStrength);
                    steer.sub(this.velocity);
                    steer.limit(this.maxForce * params.avoidStrength);
                }

                return steer;
            }

            // åˆ†é›¢ï¼ˆä»–ã®é­šã‹ã‚‰é›¢ã‚Œã‚‹ï¼‰
            separation(boids) {
                let steer = new Vector2D(0, 0);
                let count = 0;

                boids.forEach(other => {
                    const d = this.position.dist(other.position);
                    
                    // åŒã˜ç¨®é¡ã®é­šã¨ã®åˆ†é›¢
                    if (other.fishType === this.fishType && d > 0 && d < this.fishType.separationRange) {
                        let diff = this.position.sub(other.position);
                        diff.normalize().div(d);
                        steer.add(diff);
                        count++;
                    }
                    // ç•°ãªã‚‹ç¨®é¡ã®é­šã¨ã‚‚æœ€å°è·é›¢ã‚’ä¿ã¤ï¼ˆè¡çªå›é¿ï¼‰
                    else if (other.fishType !== this.fishType && d > 0 && d < 40) {
                        let diff = this.position.sub(other.position);
                        diff.normalize().div(d);
                        diff.mult(2.0); // ç•°ãªã‚‹ç¨®é¡ã‹ã‚‰ã¯ã•ã‚‰ã«å¼·ãé›¢ã‚Œã‚‹
                        steer.add(diff);
                        count++;
                    }
                });

                if (count > 0) {
                    steer.div(count);
                    steer.setMag(this.maxSpeed);
                    steer.sub(this.velocity);
                    steer.limit(this.maxForce);
                }

                return steer;
            }

            // æ•´åˆ—ï¼ˆåŒã˜æ–¹å‘ã«é€²ã‚€ï¼‰
            alignment(boids) {
                let sum = new Vector2D(0, 0);
                let count = 0;

                boids.forEach(other => {
                    const d = this.position.dist(other.position);
                    // åŒã˜ç¨®é¡ã®é­šã¨ã®ã¿ç¾¤ã‚Œã‚‹
                    if (other.fishType === this.fishType && d > 0 && d < this.fishType.alignmentRange) {
                        sum.add(other.velocity);
                        count++;
                    }
                });

                if (count > 0) {
                    sum.div(count);
                    sum.setMag(this.maxSpeed);
                    let steer = sum.sub(this.velocity);
                    steer.limit(this.maxForce);
                    return steer;
                }

                return new Vector2D(0, 0);
            }

            // çµåˆï¼ˆç¾¤ã‚Œã®ä¸­å¿ƒã«å‘ã‹ã†ï¼‰
            cohesion(boids) {
                let sum = new Vector2D(0, 0);
                let count = 0;

                boids.forEach(other => {
                    const d = this.position.dist(other.position);
                    // åŒã˜ç¨®é¡ã®é­šã¨ã®ã¿ç¾¤ã‚Œã‚‹
                    if (other.fishType === this.fishType && d > 0 && d < this.fishType.cohesionRange) {
                        sum.add(other.position);
                        count++;
                    }
                });

                if (count > 0) {
                    sum.div(count);
                    return this.seek(sum);
                }

                return new Vector2D(0, 0);
            }

            seek(target) {
                let desired = target.sub(this.position);
                desired.setMag(this.maxSpeed);
                let steer = desired.sub(this.velocity);
                steer.limit(this.maxForce);
                return steer;
            }

            // ãƒ©ãƒ³ãƒ€ãƒ ãªå‹•ãï¼ˆWander behaviorï¼‰
            wander() {
                // ãƒ©ãƒ³ãƒ€ãƒ ãªè§’åº¦å¤‰åŒ–
                this.wanderAngle += (Math.random() - 0.5) * this.angleChange;
                
                // é€²è¡Œæ–¹å‘ã®å…ˆã«ã‚ã‚‹å††å‘¨ä¸Šã®ãƒã‚¤ãƒ³ãƒˆã‚’ç›®æ¨™ã«ã™ã‚‹
                let futurePos = this.velocity.copy().normalize().mult(this.wanderDistance);
                futurePos.add(this.position);
                
                let wanderOffset = new Vector2D(
                    Math.cos(this.wanderAngle) * this.wanderRadius,
                    Math.sin(this.wanderAngle) * this.wanderRadius
                );
                
                let target = new Vector2D(futurePos.x + wanderOffset.x, futurePos.y + wanderOffset.y);
                
                return this.seek(target);
            }

            // è¡Œå‹•ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸç‰¹æ®Šãªå‹•ã
            specialBehavior() {
                let force = new Vector2D(0, 0);
                
                switch(this.behaviorType) {
                    case 'territorial': // ç¸„å¼µã‚Šæ„è­˜ãŒå¼·ã„ - ä¸€å®šç¯„å›²å†…ã«ç•™ã¾ã‚ã†ã¨ã™ã‚‹
                        const centerAttraction = 0.0003;
                        const toCenter = new Vector2D(mainCanvas.width / 2, mainCanvas.height / 2).sub(this.position);
                        if (toCenter.mag() > 300) {
                            force = toCenter.mult(centerAttraction);
                        }
                        break;
                        
                    case 'explorer': // æ¢ç´¢çš„ - åºƒç¯„å›²ã‚’ç§»å‹•
                        if (Math.random() < 0.01) { // 1%ã®ç¢ºç‡ã§æ–¹å‘è»¢æ›
                            force = new Vector2D(Math.random() * 2 - 1, Math.random() * 2 - 1).mult(0.5);
                        }
                        break;
                        
                    case 'darting': // ç´ æ—©ã„å‹•ã - æ€¥åŠ é€Ÿãƒ»æ€¥åœæ­¢
                        if (Math.random() < 0.02) { // 2%ã®ç¢ºç‡ã§æ€¥åŠ é€Ÿ
                            force = this.velocity.copy().normalize().mult(0.8);
                        }
                        break;
                        
                    case 'graceful': // å„ªé›… - æ»‘ã‚‰ã‹ãªæ›²ç·šã‚’æã
                        const time = Date.now() * 0.001;
                        force = new Vector2D(
                            Math.sin(time + this.position.x * 0.01) * 0.05,
                            Math.cos(time + this.position.y * 0.01) * 0.05
                        );
                        break;
                        
                    case 'playful': // éŠã³å¿ƒãŒã‚ã‚‹ - ãƒ©ãƒ³ãƒ€ãƒ ãªå‹•ããŒå¤šã„
                        if (Math.random() < 0.03) {
                            force = new Vector2D(
                                (Math.random() - 0.5) * 0.6,
                                (Math.random() - 0.5) * 0.6
                            );
                        }
                        break;
                }
                
                return force;
            }

            flock(boids, hands) {
                let sep = this.separation(boids);
                let ali = this.alignment(boids);
                let coh = this.cohesion(boids);
                let avoid = this.avoidHands(hands);
                let wand = this.wander();
                let special = this.specialBehavior();

                // é‡ã¿ä»˜ã‘ï¼ˆåˆ†é›¢ã‚’æœ€å„ªå…ˆï¼‰
                sep.mult(2.5); // åˆ†é›¢ã‚’ã•ã‚‰ã«å¼·åŒ–
                ali.mult(1.0);
                coh.mult(1.0);
                avoid.mult(3.0); // æ‰‹ã‹ã‚‰ã®é€ƒé¿ã‚’å¼·ã
                wand.mult(this.wanderStrength); // ç¨®é¡ã”ã¨ã®ãƒ©ãƒ³ãƒ€ãƒ ã•
                special.mult(1.0); // ç‰¹æ®Šè¡Œå‹•

                this.applyForce(sep);
                this.applyForce(ali);
                this.applyForce(coh);
                this.applyForce(avoid);
                this.applyForce(wand);
                this.applyForce(special);
            }

            update() {
                this.velocity.add(this.acceleration);
                this.velocity.limit(this.maxSpeed * this.speedVariation);
                this.position.add(this.velocity);
                this.acceleration.mult(0);

                // ç”»é¢ç«¯ã§æŠ˜ã‚Šè¿”ã—
                if (this.position.x < 0) this.position.x = mainCanvas.width;
                if (this.position.x > mainCanvas.width) this.position.x = 0;
                if (this.position.y < 0) this.position.y = mainCanvas.height;
                if (this.position.y > mainCanvas.height) this.position.y = 0;
            }

            draw(ctx) {
                const angle = Math.atan2(this.velocity.y, this.velocity.x);
                
                ctx.save();
                ctx.translate(this.position.x, this.position.y);
                ctx.rotate(angle);
                
                // é­šã®ä½“
                ctx.fillStyle = `hsl(${this.hue}, ${this.saturation}%, ${this.lightness}%)`;
                ctx.beginPath();
                ctx.ellipse(0, 0, this.size, this.size * 0.5, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // å°¾ã³ã‚Œ
                ctx.fillStyle = `hsl(${this.hue}, ${this.saturation - 10}%, ${this.lightness - 10}%)`;
                ctx.beginPath();
                ctx.moveTo(-this.size, 0);
                ctx.lineTo(-this.size * 1.5, -this.size * 0.4);
                ctx.lineTo(-this.size * 1.5, this.size * 0.4);
                ctx.closePath();
                ctx.fill();
                
                // ç›®
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(this.size * 0.5, -this.size * 0.2, this.size * 0.15, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(this.size * 0.5, -this.size * 0.2, this.size * 0.08, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }
        }

        // ãƒœã‚¤ãƒ‰åˆæœŸåŒ–
        function initBoids() {
            boids = [];
            
            // å„ç¨®é¡ã®é­šã‚’ç”Ÿæˆ
            fishTypes.forEach(fishType => {
                for (let i = 0; i < fishType.schoolSize; i++) {
                    boids.push(new Boid(
                        Math.random() * mainCanvas.width,
                        Math.random() * mainCanvas.height,
                        fishType
                    ));
                }
            });
            
            fishCountElement.textContent = boids.length;
        }

        // æ‰‹ã®æ¤œå‡ºçµæœå‡¦ç†
        function onResults(results) {
            handPositions = [];

            if (results.multiHandLandmarks) {
                handStatusElement.textContent = `âœ… (${results.multiHandLandmarks.length}æ‰‹)`;
                
                for (const landmarks of results.multiHandLandmarks) {
                    // æ‰‹ã®ã²ã‚‰ã®ä¸­å¿ƒï¼ˆãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯0: æ‰‹é¦–ã€9: ä¸­æŒ‡ã®ä»˜ã‘æ ¹ã®ä¸­é–“ï¼‰
                    const palm = landmarks[9];
                    
                    // ãƒ“ãƒ‡ã‚ªåº§æ¨™ã‹ã‚‰ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã«å¤‰æ›ï¼ˆãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°å¯¾å¿œï¼‰
                    const x = (1 - palm.x) * mainCanvas.width;
                    const y = palm.y * mainCanvas.height;
                    
                    handPositions.push(new Vector2D(x, y));
                }
            } else {
                handStatusElement.textContent = 'âŒ';
            }
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
        function animate() {
            // èƒŒæ™¯ï¼ˆæ°´ä¸­åŠ¹æœï¼‰
            const gradient = mainCtx.createLinearGradient(0, 0, 0, mainCanvas.height);
            gradient.addColorStop(0, 'rgba(0, 30, 60, 0.3)');
            gradient.addColorStop(1, 'rgba(0, 50, 80, 0.3)');
            mainCtx.fillStyle = gradient;
            mainCtx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);

            // æ‰‹ã®ä½ç½®ã‚’æç”»
            handPositions.forEach(hand => {
                // é€ƒé¿ç¯„å›²ã‚’å¯è¦–åŒ–
                mainCtx.strokeStyle = 'rgba(255, 100, 100, 0.3)';
                mainCtx.lineWidth = 2;
                mainCtx.beginPath();
                mainCtx.arc(hand.x, hand.y, params.avoidRange, 0, Math.PI * 2);
                mainCtx.stroke();
                
                // æ‰‹ã®ã²ã‚‰ã‚’æç”»
                mainCtx.fillStyle = 'rgba(255, 200, 150, 0.7)';
                mainCtx.beginPath();
                mainCtx.arc(hand.x, hand.y, 20, 0, Math.PI * 2);
                mainCtx.fill();
            });

            // ãƒœã‚¤ãƒ‰ã®æ›´æ–°ã¨æç”»
            boids.forEach(boid => {
                boid.flock(boids, handPositions);
                boid.update();
                boid.draw(mainCtx);
            });

            animationId = requestAnimationFrame(animate);
        }

        // åˆæœŸåŒ–
        async function init() {
            try {
                statusElement.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...';
                console.log('åˆæœŸåŒ–é–‹å§‹...');

                // ã‚«ãƒ¡ãƒ©èµ·å‹•
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                video.srcObject = stream;
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play().then(() => {
                            console.log('ãƒ“ãƒ‡ã‚ªå†ç”Ÿé–‹å§‹');
                            resolve();
                        });
                    };
                });

                statusElement.textContent = 'MediaPipeã‚’åˆæœŸåŒ–ä¸­...';
                console.log('MediaPipe Handsã‚’åˆæœŸåŒ–ä¸­...');

                // MediaPipe Handsã®è¨­å®š
                hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });

                hands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                hands.onResults(onResults);
                console.log('MediaPipe HandsåˆæœŸåŒ–å®Œäº†');

                // ãƒœã‚¤ãƒ‰åˆæœŸåŒ–
                initBoids();

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                animate();
                console.log('ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—é–‹å§‹');

                // ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ãƒ«ãƒ¼ãƒ—
                async function processFrame() {
                    if (video.readyState === 4) {
                        try {
                            await hands.send({ image: video });
                        } catch (err) {
                            console.error('ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ã‚¨ãƒ©ãƒ¼:', err);
                        }
                    }
                    requestAnimationFrame(processFrame);
                }
                
                processFrame();
                
                statusElement.textContent = 'âœ¨ æ‰‹ã‚’ã‹ã–ã—ã¦é­šã‚’å‹•ã‹ã—ã¦ãã ã•ã„ï¼';
                console.log('åˆæœŸåŒ–å®Œäº†ï¼');

            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                let errorMessage = 'ã‚¨ãƒ©ãƒ¼: ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else {
                    errorMessage += error.message;
                }
                
                statusElement.textContent = errorMessage;
            }
        }

        // è‡ªå‹•èµ·å‹•
        window.addEventListener('load', () => {
            console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† - è‡ªå‹•èµ·å‹•');
            setTimeout(() => {
                init();
            }, 500);
        });
    </script>
</body>
</html>
