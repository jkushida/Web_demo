<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Face Pix2Pix Filter (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ )</title>

  <!-- æ³¨æ„: ãƒ‡ãƒ¢æ€§é‡è¦–ã®ãŸã‚CDNã‚’ä½¿ç”¨ã€‚Pix2Pixãƒ¢ãƒ‡ãƒ«URLã¯å…¥åŠ›ã§æŒ‡å®š -->
  <!-- face-api.js: é¡”æ¤œå‡ºã¨ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js" crossorigin="anonymous"></script>
  <!-- p5.js ã¯ ml5.js ãŒå†…éƒ¨ã§å‚ç…§ã™ã‚‹ãŸã‚åŒæ™‚èª­ã¿è¾¼ã¿ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js" crossorigin="anonymous"></script>
  <!-- ml5.js: pix2pix ãƒ©ãƒƒãƒ‘ãƒ¼ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ml5/0.12.2/ml5.min.js" crossorigin="anonymous"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      min-height: 100vh;
      color: #fff;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .wrap { display: flex; gap: 24px; max-width: 1200px; width: 100%; }
    .stage { flex: 1; }
    .panel { width: 360px; background: rgba(0,0,0,0.25); border-radius: 16px; padding: 16px; }
    h1 { font-size: 22px; margin-bottom: 8px; }
    .subtitle { font-size: 12px; opacity: 0.9; margin-bottom: 16px; }
    .view {
      position: relative; width: 100%; aspect-ratio: 4/3; background: #000;
      border-radius: 16px; overflow: hidden; box-shadow: 0 16px 40px rgba(0,0,0,0.3);
    }
    #video { display: none; }
    #canvas { position: absolute; inset: 0; width: 100%; height: 100%; }
    .row { margin: 10px 0; }
    label { display: block; font-size: 13px; margin-bottom: 6px; }
    input[type="text"] { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.35); background: rgba(255,255,255,0.1); color: #fff; }
    input[type="range"] { width: 100%; }
    button { padding: 8px 12px; border: none; border-radius: 8px; background: #667eea; color: #fff; cursor: pointer; }
    button:hover { background: #5469d4; }
    .status { margin-top: 8px; font-size: 12px; opacity: 0.9; }
    .kv { display: flex; gap: 8px; align-items: center; justify-content: space-between; font-size: 12px; }
    .small { font-size: 12px; opacity: 0.85; }
    .hint { font-size: 12px; opacity: 0.85; margin-top: 6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stage">
      <div class="view">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
      </div>
      <div class="kv"><span>FPS:</span><span id="fps" class="mono">0</span></div>
    </div>
    <div class="panel">
      <h1>ğŸ¨ Face Pix2Pix Filter</h1>
      <div class="subtitle">é¡”æ¤œå‡º â†’ Pix2Pixã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ› â†’ ã‚­ãƒ£ãƒ³ãƒã‚¹åˆæˆ</div>
      <div class="row">
        <label for="modelUrl">Pix2Pixãƒ¢ãƒ‡ãƒ«URLï¼ˆmodel.jsonï¼‰</label>
        <input id="modelUrl" type="text" placeholder="ä¾‹: ../assets/pix2pix/model.json" />
        <div class="hint">æ³¨æ„: 256x256å…¥åŠ›ã®Pix2Pixãƒ¢ãƒ‡ãƒ«ã‚’æƒ³å®šã€‚<br>ã“ã®ãƒšãƒ¼ã‚¸ã¯ <span class="mono">MediaPipe/</span> é…ä¸‹ãªã®ã§ã€ãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ <span class="mono">assets/</span> ã¸ã¯ <span class="mono">../assets/...</span> ã®ç›¸å¯¾ãƒ‘ã‚¹ã§å‚ç…§ã—ã¦ãã ã•ã„ã€‚</div>
      </div>
      <div class="row">
        <button id="loadBtn">ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿</button>
        <div id="modelStatus" class="status">æœªèª­ã¿è¾¼ã¿</div>
      </div>
      <div class="row">
        <label for="alpha">ã‚¹ã‚¿ã‚¤ãƒ«å¼·åº¦: <span id="alphaVal">0.8</span></label>
        <input id="alpha" type="range" min="0" max="1" step="0.01" value="0.8" />
      </div>
      <div class="row small">
        <div>face-api.js: TinyFaceDetector + 68ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯</div>
        <div>å‡¦ç†è² è·ã‚’è€ƒæ…®ã—ã€æ¤œå‡º/å¤‰æ›ã¯é–“å¼•ãï¼ˆçµæœã¯ä¿æŒï¼‰</div>
      </div>
    </div>
  </div>

  <script>
    // DOM
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const fpsEl = document.getElementById('fps');
    const alphaEl = document.getElementById('alpha');
    const alphaValEl = document.getElementById('alphaVal');
    const modelUrlEl = document.getElementById('modelUrl');
    const loadBtn = document.getElementById('loadBtn');
    const modelStatusEl = document.getElementById('modelStatus');

    // çŠ¶æ…‹
    let isRunning = false;
    let lastTime = performance.now();
    let frames = 0;
    let lastFpsUpdate = performance.now();

    // face-api: ãƒ¢ãƒ‡ãƒ«URLï¼ˆvladmandicã®ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒƒã‚¯ã‚’åˆ©ç”¨ï¼‰
    const FACEAPI_MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';
    // Pix2Pix: æ—¢å®šã®ãƒ¢ãƒ‡ãƒ«URLï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¨å¥¨: assets/ é…ä¸‹ã«é…ç½®ã—ç›¸å¯¾å‚ç…§ï¼‰
    // æ³¨æ„: ã“ã®ãƒšãƒ¼ã‚¸ã¯ MediaPipe/ é…ä¸‹ãªã®ã§ã€ãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã® assets/ ã¯ ../assets/
    const DEFAULT_MODEL_URL = '../assets/pix2pix/model.json';

    // æ¤œå‡ºè¨­å®š
    const detectorOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 256, scoreThreshold: 0.5 });
    const detectEveryN = 2; // Nãƒ•ãƒ¬ãƒ¼ãƒ ã«1å›æ¤œå‡º
    const pixEveryN = 3;    // Nãƒ•ãƒ¬ãƒ¼ãƒ ã«1å›Pix2Pix
    let frameCount = 0;

    // Pix2Pix
    let pix2pixModel = null;       // ml5.pix2pix ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    let lastPix2PixImage = null;   // å‰å›ã®ç”Ÿæˆçµæœï¼ˆHTMLImageElementï¼‰
    let isTransferring = false;

    // ä½œæ¥­ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹
    const offCanvas = document.createElement('canvas');
    const offCtx = offCanvas.getContext('2d');
    offCanvas.width = 256;
    offCanvas.height = 256;

    // UI
    alphaEl.addEventListener('input', () => {
      alphaValEl.textContent = Number(alphaEl.value).toFixed(2);
    });

    function resolveModelUrl(u) {
      if (!u) return u;
      // çµ¶å¯¾URL or ãƒ«ãƒ¼ãƒˆç›¸å¯¾ã¯ãã®ã¾ã¾
      if (/^https?:\/\//.test(u) || u.startsWith('/')) return u;
      // MediaPipe/ ä¸‹ã‹ã‚‰ã®ç›¸å¯¾: assets/ ã§å§‹ã¾ã‚‹å ´åˆã¯ ../ ã‚’è£œã†
      if (u.startsWith('assets/')) return '../' + u;
      return u;
    }

    async function loadPix2Pix(url) {
      const u = resolveModelUrl((url || '').trim());
      if (!u) {
        modelStatusEl.textContent = 'ãƒ¢ãƒ‡ãƒ«URLãŒç©ºã§ã™';
        return;
      }
      try {
        modelStatusEl.textContent = 'ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...';
        pix2pixModel = await ml5.pix2pix(u);
        modelStatusEl.textContent = 'ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº† âœ…';
      } catch (e) {
        console.error('Pix2Pix load error for URL:', u, e);
        modelStatusEl.textContent = 'ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•— âŒï¼ˆURL/ãƒ‘ã‚¹ã‚’ç¢ºèªï¼‰: ' + (e && e.message ? e.message : e);
      }
    }

    loadBtn.addEventListener('click', async () => {
      await loadPix2Pix(modelUrlEl.value);
    });

    // ã‚«ãƒ¡ãƒ©é–‹å§‹
    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'user' } });
      video.srcObject = stream;
      await new Promise((res) => (video.onloadedmetadata = res));
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }

    // face-api ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿
    async function loadFaceApiModels() {
      await faceapi.nets.tinyFaceDetector.loadFromUri(FACEAPI_MODEL_URL);
      await faceapi.nets.faceLandmark68Net.loadFromUri(FACEAPI_MODEL_URL);
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ROIï¼ˆé¡”ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ï¼‹ä½™ç™½ï¼‰
    function getFaceRoi(box, pad = 0.25) {
      const { x, y, width, height } = box;
      const cx = x + width / 2;
      const cy = y + height / 2;
      const size = Math.max(width, height) * (1 + pad);
      const left = Math.max(0, Math.floor(cx - size / 2));
      const top = Math.max(0, Math.floor(cy - size / 2));
      const right = Math.min(canvas.width, Math.ceil(cx + size / 2));
      const bottom = Math.min(canvas.height, Math.ceil(cy + size / 2));
      return { x: left, y: top, w: right - left, h: bottom - top };
    }

    // Pix2Pix æ¨è«–ï¼ˆé–“å¼•ãå®Ÿè¡Œï¼†çµæœä¿æŒï¼‰
    async function runPix2Pix(roi) {
      if (!pix2pixModel || isTransferring) return; // æœªãƒ­ãƒ¼ãƒ‰ or å®Ÿè¡Œä¸­
      isTransferring = true;
      try {
        // ROIã‚’256x256ã¸
        offCtx.clearRect(0, 0, offCanvas.width, offCanvas.height);
        offCtx.drawImage(canvas, roi.x, roi.y, roi.w, roi.h, 0, 0, 256, 256);

        await new Promise((resolve) => {
          pix2pixModel.transfer(offCanvas, (err, result) => {
            if (err) {
              console.error('pix2pix error:', err);
              return resolve();
            }
            lastPix2PixImage = new Image();
            lastPix2PixImage.onload = () => resolve();
            lastPix2PixImage.src = result.image.src;
          });
        });
      } catch (e) {
        console.error(e);
      } finally {
        isTransferring = false;
      }
    }

    // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
    async function loop() {
      requestAnimationFrame(loop);
      if (!isRunning) return;

      // èƒŒæ™¯ãƒ•ãƒ¬ãƒ¼ãƒ æç”»
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // é¡”æ¤œå‡ºï¼ˆé–“å¼•ãï¼‰
      let detection = null;
      if (frameCount % detectEveryN === 0) {
        const result = await faceapi
          .detectSingleFace(video, detectorOptions)
          .withFaceLandmarks();
        if (result) detection = result;
        window.__lastDet = detection || window.__lastDet || null;
      } else {
        detection = window.__lastDet || null;
      }

      if (detection && detection.detection) {
        const box = detection.detection.box;
        const roi = getFaceRoi(box, 0.35);

        // Pix2Pixï¼ˆé–“å¼•ãï¼‰
        if (frameCount % pixEveryN === 0) {
          runPix2Pix(roi);
        }

        // åˆæˆ: ç”ŸæˆçµæœãŒã‚ã‚Œã°ãƒ–ãƒ¬ãƒ³ãƒ‰ï¼ˆé¡”ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‹ã‚‰ãƒã‚¹ã‚¯ä½œæˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§æ¥•å††ï¼‰
        if (lastPix2PixImage) {
          const alpha = Number(alphaEl.value);
          const lm = detection.landmarks ? detection.landmarks.getPositions() : null;

          ctx.save();
          if (lm && lm.length >= 68) {
            // 68ç‚¹ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯: é¡(0-16) + çœ‰(17-26)ã‚’ä½¿ã£ã¦ãƒãƒªã‚´ãƒ³ã‚’æ§‹ç¯‰
            ctx.beginPath();
            // é¡ã®ãƒ©ã‚¤ãƒ³ 0 â†’ 16
            ctx.moveTo(lm[0].x, lm[0].y);
            for (let i = 1; i <= 16; i++) ctx.lineTo(lm[i].x, lm[i].y);
            // å³çœ‰ 26 â†’ 22ï¼ˆé€†é †ã§å¤–å‘¨ã£ã½ãï¼‰
            for (let i = 26; i >= 22; i--) ctx.lineTo(lm[i].x, lm[i].y);
            // å·¦çœ‰ 21 â†’ 17ï¼ˆé€†é †ï¼‰
            for (let i = 21; i >= 17; i--) ctx.lineTo(lm[i].x, lm[i].y);
            ctx.closePath();
            ctx.clip();
          } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ¥•å††ãƒã‚¹ã‚¯
            ctx.beginPath();
            const cx = roi.x + roi.w / 2;
            const cy = roi.y + roi.h / 2;
            const rx = roi.w * 0.5;
            const ry = roi.h * 0.62;
            ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
            ctx.clip();
          }

          ctx.globalAlpha = alpha;
          ctx.drawImage(lastPix2PixImage, roi.x, roi.y, roi.w, roi.h);
          ctx.restore();
          ctx.globalAlpha = 1.0;
        }

        // ãƒ‡ãƒãƒƒã‚°: ROIè¡¨ç¤ºï¼ˆè–„æ ï¼‰
        // ctx.strokeStyle = 'rgba(255,255,255,0.4)';
        // ctx.strokeRect(roi.x, roi.y, roi.w, roi.h);
      }

      // FPS
      frames++;
      const now = performance.now();
      if (now - lastFpsUpdate > 1000) {
        fpsEl.textContent = String(frames);
        frames = 0;
        lastFpsUpdate = now;
      }
      frameCount++;
    }

    (async function main() {
      try {
        await setupCamera();
        await loadFaceApiModels();
        // æ—¢å®šURLï¼ˆ../assets/...ï¼‰ã‚’å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆã—ã€è‡ªå‹•ã§Pix2Pixãƒ¢ãƒ‡ãƒ«ã‚’äº‹å‰èª­ã¿è¾¼ã¿
        modelUrlEl.value = DEFAULT_MODEL_URL;
        await loadPix2Pix(DEFAULT_MODEL_URL);
        isRunning = true;
        loop();
      } catch (e) {
        console.error(e);
        alert('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    })();
  </script>
</body>
</html>
