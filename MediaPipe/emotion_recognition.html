<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊÑüÊÉÖ„ÅÆÈè° - Emotion Recognition Enhanced</title>
    
    <!-- MediaPipe CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <!-- Face-api.js for AI Emotion Recognition -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 30px;
            max-width: 1400px;
            width: 100%;
        }

        .video-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            aspect-ratio: 4/3;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            background: #000;
        }

        #inputVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            display: none;
        }

        #outputCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }

        .video-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .toggle-button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: bold;
        }

        .toggle-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .toggle-button.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: #fff;
        }

        .controls-section {
            flex: 0 0 400px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-message {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        .status-message.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }

        .status-message.loading {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
            animation: pulse 2s infinite;
        }

        .emotion-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .current-emotion {
            font-size: 72px;
            margin-bottom: 10px;
        }

        .emotion-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .confidence {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .emotion-meters {
            margin-bottom: 20px;
        }

        .emotion-meter {
            margin-bottom: 15px;
        }

        .emotion-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .emotion-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .emotion-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .emotion-fill.happy {
            background: linear-gradient(90deg, #FFD700, #FFA500);
        }

        .emotion-fill.sad {
            background: linear-gradient(90deg, #4169E1, #1E90FF);
        }

        .emotion-fill.angry {
            background: linear-gradient(90deg, #DC143C, #FF6347);
        }

        .emotion-fill.surprised {
            background: linear-gradient(90deg, #FF69B4, #FFB6C1);
        }

        .emotion-fill.neutral {
            background: linear-gradient(90deg, #708090, #A9A9A9);
        }

        .settings {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .setting-group {
            margin-bottom: 15px;
        }

        .setting-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }

        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            font-size: 12px;
            font-family: monospace;
        }

        .debug-item {
            margin: 5px 0;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-section">
            <div class="video-container">
                <video id="inputVideo" autoplay playsinline></video>
                <canvas id="outputCanvas"></canvas>
            </div>
            <div class="video-controls">
                <button class="toggle-button active" id="landmarksToggle" onclick="toggleLandmarks()">
                    üëÅÔ∏è „É©„É≥„Éâ„Éû„Éº„ÇØË°®Á§∫
                </button>
                <button class="toggle-button active" id="meshToggle" onclick="toggleMesh()">
                    üîó „É°„ÉÉ„Ç∑„É•Ë°®Á§∫
                </button>
                
            </div>
        </div>

        <div class="controls-section">
            <h1>üé≠ ÊÑüÊÉÖ„ÅÆÈè°</h1>
            <p class="subtitle">Face-api.js AIÊÑüÊÉÖË™çË≠ò + MediaPipe Face Mesh v2.0</p>

            <div class="status-message" id="statusMessage">
                üöÄ „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ‰∏≠... AIÊÑüÊÉÖË™çË≠ò„É¢„Éá„É´„ÇíÊ∫ñÂÇô„Åó„Å¶„ÅÑ„Åæ„Åô
            </div>

            <div class="emotion-display">
                <div class="current-emotion pulse" id="currentEmoji">üé≠</div>
                <div class="emotion-name" id="currentEmotion">ÂæÖÊ©ü‰∏≠</div>
                <div class="confidence">‰ø°È†ºÂ∫¶: <span id="confidence">0</span>%</div>
            </div>

            <div class="emotion-meters">
                <div class="emotion-meter">
                    <div class="emotion-label">
                        <span>üòä Âñú„Å≥</span>
                        <span id="happy-value">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <div class="emotion-fill happy" id="happy-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="emotion-meter">
                    <div class="emotion-label">
                        <span>üò¢ ÊÇ≤„Åó„Åø</span>
                        <span id="sad-value">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <div class="emotion-fill sad" id="sad-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="emotion-meter">
                    <div class="emotion-label">
                        <span>üò† ÊÄí„Çä</span>
                        <span id="angry-value">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <div class="emotion-fill angry" id="angry-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="emotion-meter">
                    <div class="emotion-label">
                        <span>üò≤ È©ö„Åç</span>
                        <span id="surprised-value">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <div class="emotion-fill surprised" id="surprised-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="emotion-meter">
                    <div class="emotion-label">
                        <span>üòê ‰∏≠Á´ã</span>
                        <span id="neutral-value">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <div class="emotion-fill neutral" id="neutral-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="settings">
                <h3>‚öôÔ∏è Ë®≠ÂÆö</h3>
                <div class="setting-group">
                    <label class="setting-label">
                        ÊÑüÂ∫¶ (Âñú„Å≥): <span id="happySensitivity-value">50</span>%
                    </label>
                    <input type="range" class="slider" id="happySensitivity" 
                           min="10" max="100" value="50" oninput="updateSensitivity('happy')">
                </div>
                <div class="setting-group">
                    <label class="setting-label">
                        ÊÑüÂ∫¶ (ÂÖ®‰Ωì): <span id="overallSensitivity-value">50</span>%
                    </label>
                    <input type="range" class="slider" id="overallSensitivity" 
                           min="10" max="100" value="50" oninput="updateSensitivity('overall')">
                </div>
            </div>

            <div class="debug-info" id="debugInfo">
                <div class="debug-item">üìä FPS: <span id="fps">0</span></div>
                <div class="debug-item">üë§ È°îÊ§úÂá∫: <span id="faceDetected">„Å™„Åó</span></div>
                <div class="debug-item">üìç „É©„É≥„Éâ„Éû„Éº„ÇØ: <span id="landmarkCount">0</span></div>
                <div class="debug-item">üòä Âè£Ëßí‰∏äÊòáÂÄ§: <span id="smileValue">0.00</span></div>
                <div class="debug-item">üëÑ Âè£„ÅÆÈñã„Åç: <span id="mouthOpen">0.00</span></div>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let videoElement = document.getElementById('inputVideo');
        let canvasElement = document.getElementById('outputCanvas');
        let canvasCtx = canvasElement.getContext('2d');
        let camera = null;
        let faceMesh = null;
        let isRunning = false;
        let lastFrameTime = Date.now();
        let frameCount = 0;
        
        // Ë°®Á§∫Ë®≠ÂÆö
        let showLandmarks = true;
        let showMesh = true;
        let showVideo = false;
        
        // ÊÑüÂ∫¶Ë®≠ÂÆö
        let happySensitivity = 50;
        let overallSensitivity = 50;
        
        // Face-api.js Â§âÊï∞ÔºàAIÊÑüÊÉÖË™çË≠òÁî®Ôºâ
        let faceApiModelsLoaded = false;
        let lastEmotionDetection = null;
        let isDetectingEmotion = false;
        
        // ÊÑüÊÉÖ„ÅÆÁµµÊñáÂ≠ó„Å®ÂêçÂâç
        const emotionEmojis = {
            happy: 'üòä',
            sad: 'üò¢',
            angry: 'üò†',
            surprised: 'üò≤',
            neutral: 'üòê'
        };
        
        const emotionNames = {
            happy: 'Âñú„Å≥',
            sad: 'ÊÇ≤„Åó„Åø',
            angry: 'ÊÄí„Çä',
            surprised: 'È©ö„Åç',
            neutral: '‰∏≠Á´ã'
        };
        
        // „É©„É≥„Éâ„Éû„Éº„ÇØ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºàMediaPipe Face MeshÔºâ
        const LANDMARKS = {
            // Âè£„ÅÆÂë®„Çä
            MOUTH_LEFT: 61,
            MOUTH_RIGHT: 291,
            MOUTH_TOP: 13,
            MOUTH_BOTTOM: 14,
            UPPER_LIP_TOP: 12,
            LOWER_LIP_BOTTOM: 15,
            MOUTH_CENTER: 13,
            
            // Âè£Ëßí
            LEFT_MOUTH_CORNER: 61,
            RIGHT_MOUTH_CORNER: 291,
            
            // ÁõÆ
            LEFT_EYE_TOP: 159,
            LEFT_EYE_BOTTOM: 145,
            RIGHT_EYE_TOP: 386,
            RIGHT_EYE_BOTTOM: 374,
            
            // Áúâ
            LEFT_EYEBROW_INNER: 70,
            LEFT_EYEBROW_OUTER: 63,
            RIGHT_EYEBROW_INNER: 107,
            RIGHT_EYEBROW_OUTER: 55,
            
            // È†¨
            LEFT_CHEEK: 116,
            RIGHT_CHEEK: 345
        };
        
        // Ëá™ÂãïËµ∑Âãï
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded - Ëá™ÂãïËµ∑ÂãïÈñãÂßã');
            loadFaceApiModels(); // Face-api.js„É¢„Éá„É´„ÇíË™≠„ÅøËæº„Åø
            setTimeout(startDetection, 1000); // 1ÁßíÂæå„Å´Ëá™ÂãïËµ∑Âãï
        });
        
        // Face-api.js„ÅÆ„É¢„Éá„É´„ÇíË™≠„ÅøËæº„ÇÄ
        async function loadFaceApiModels() {
            try {
                updateStatus('ü§ñ AIÊÑüÊÉÖË™çË≠ò„É¢„Éá„É´Ê∫ñÂÇô‰∏≠... (ÂàùÂõû„ÅØÊï∞Áßí„Åã„Åã„Çä„Åæ„Åô)', 'loading');
                console.log('Face-api.js „É¢„Éá„É´„ÅÆË™≠„ÅøËæº„Åø„ÇíÈñãÂßã...');
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';
                
                // ÊÑüÊÉÖË™çË≠ò„Å´ÂøÖË¶Å„Å™„É¢„Éá„É´„ÅÆ„Åø„ÇíË™≠„ÅøËæº„ÇÄ
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
                ]);
                
                faceApiModelsLoaded = true;
                console.log('Face-api.js „É¢„Éá„É´„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÔºÅ');
                updateStatus('‚úÖ AIÊÑüÊÉÖË™çË≠ò„É¢„Éá„É´Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ', 'success');
            } catch (error) {
                console.error('Face-api.js „É¢„Éá„É´„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                faceApiModelsLoaded = false;
                updateStatus('‚ö†Ô∏è AI„É¢„Éá„É´Ë™≠„ÅøËæº„ÅøÂ§±Êïó - „É´„Éº„É´„Éô„Éº„ÇπÊé®ÂÆö„ÅßÂãï‰Ωú„Åó„Åæ„Åô', 'error');
            }
        }
        
        function setupCanvas() {
            canvasElement.width = 640;
            canvasElement.height = 480;
        }
        
        async function startDetection() {
            try {
                // AI„É¢„Éá„É´„ÅÆÊ∫ñÂÇô„ÇíÂæÖ„Å§
                if (!faceApiModelsLoaded) {
                    updateStatus('‚è≥ AIÊÑüÊÉÖË™çË≠ò„É¢„Éá„É´„ÅÆÊ∫ñÂÇô„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...', 'loading');
                    // „É¢„Éá„É´„ÅåË™≠„ÅøËæº„Åæ„Çå„Çã„Åæ„ÅßÂæÖÊ©üÔºàÊúÄÂ§ß10ÁßíÔºâ
                    let waitCount = 0;
                    while (!faceApiModelsLoaded && waitCount < 50) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                        waitCount++;
                    }
                    
                    if (!faceApiModelsLoaded) {
                        updateStatus('‚ö†Ô∏è AI„É¢„Éá„É´Ê∫ñÂÇô„Çø„Ç§„É†„Ç¢„Ç¶„Éà - „É´„Éº„É´„Éô„Éº„Çπ„ÅßËµ∑Âãï„Åó„Åæ„Åô', 'error');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                updateStatus('üìπ „Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠...', 'loading');
                await setupCamera();
                
                updateStatus('üîÑ MediaPipe„ÇíÂàùÊúüÂåñ‰∏≠...', 'loading');
                await setupFaceMesh();
                
                const modelStatus = faceApiModelsLoaded ? 'ü§ñ AIÊÑüÊÉÖË™çË≠ò' : 'üìä „É´„Éº„É´„Éô„Éº„ÇπÊé®ÂÆö';
                updateStatus(`‚úÖ ÊÑüÊÉÖË™çË≠ò„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü (${modelStatus})`, 'success');
                isRunning = true;
                
            } catch (error) {
                console.error('„Ç®„É©„Éº:', error);
                updateStatus('‚ùå „Ç®„É©„Éº: ' + error.message, 'error');
            }
        }
        
        async function setupCamera() {
            console.log('„Ç´„É°„É©„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÈñãÂßã');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: 640,
                        height: 480,
                        facingMode: 'user'
                    }
                });
                
                videoElement.srcObject = stream;
                videoElement.style.display = 'block';
                
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        console.log('„Ç´„É°„É©Ê∫ñÂÇôÂÆå‰∫Ü');
                        setupCanvas();
                        resolve();
                    };
                });
                
            } catch (error) {
                console.error('„Ç´„É°„É©„Ç®„É©„Éº:', error);
                throw new Error('„Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì');
            }
        }
        
        async function setupFaceMesh() {
            console.log('MediaPipe FaceMeshÂàùÊúüÂåñÈñãÂßã');
            
            faceMesh = new FaceMesh({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                }
            });
            
            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            faceMesh.onResults(onResults);
            
            camera = new Camera(videoElement, {
                onFrame: async () => {
                    if (faceMesh && isRunning) {
                        await faceMesh.send({image: videoElement});
                    }
                },
                width: 640,
                height: 480
            });
            
            camera.start();
            console.log('„Ç´„É°„É©„Çπ„Éà„É™„Éº„Éü„É≥„Ç∞ÈñãÂßã');
        }
        
        async function onResults(results) {
            // FPSË®àÁÆó
            frameCount++;
            const now = Date.now();
            if (now - lastFrameTime > 1000) {
                document.getElementById('fps').textContent = frameCount;
                frameCount = 0;
                lastFrameTime = now;
            }
            
            // „Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„Ç¢
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // „Éì„Éá„Ç™„Éï„É¨„Éº„É†ÊèèÁîª
            if (showVideo) {
                canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            }
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                document.getElementById('faceDetected').textContent = '„ÅÇ„Çä';
                document.getElementById('landmarkCount').textContent = landmarks.length;
                
                // „É°„ÉÉ„Ç∑„É•ÊèèÁîª
                if (showMesh) {
                    drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, 
                        {color: '#C0C0C070', lineWidth: 1});
                    drawConnectors(canvasCtx, landmarks, FACEMESH_FACE_OVAL, 
                        {color: '#E0E0E0', lineWidth: 2});
                }
                
                // „É©„É≥„Éâ„Éû„Éº„ÇØÊèèÁîª
                if (showLandmarks) {
                    // ÈáçË¶Å„Å™„É©„É≥„Éâ„Éû„Éº„ÇØ„ÇíÂº∑Ë™øË°®Á§∫
                    drawImportantLandmarks(landmarks);
                    
                    // Âè£„ÅÆ„É©„É≥„Éâ„Éû„Éº„ÇØ„ÇíÁâπÂà•„Å´Ë°®Á§∫
                    drawConnectors(canvasCtx, landmarks, FACEMESH_LIPS, 
                        {color: '#FF3030', lineWidth: 2});
                }
                
                // AIÊÑüÊÉÖÊé®ÂÆö
                const emotions = await estimateEmotions(landmarks);
                updateEmotionDisplay(emotions);
                
            } else {
                document.getElementById('faceDetected').textContent = '„Å™„Åó';
                document.getElementById('landmarkCount').textContent = '0';
            }
            
            canvasCtx.restore();
        }
        
        function drawImportantLandmarks(landmarks) {
            // Âè£Ëßí„ÇíËµ§„ÅßË°®Á§∫
            canvasCtx.fillStyle = '#FF0000';
            drawLandmark(landmarks[LANDMARKS.LEFT_MOUTH_CORNER], 5);
            drawLandmark(landmarks[LANDMARKS.RIGHT_MOUTH_CORNER], 5);
            
            // Âè£„ÅÆ‰∏≠ÂøÉ„ÇíÈùí„ÅßË°®Á§∫
            canvasCtx.fillStyle = '#0000FF';
            drawLandmark(landmarks[LANDMARKS.MOUTH_TOP], 4);
            drawLandmark(landmarks[LANDMARKS.MOUTH_BOTTOM], 4);
            
            // ÁõÆ„ÇíÁ∑ë„ÅßË°®Á§∫
            canvasCtx.fillStyle = '#00FF00';
            drawLandmark(landmarks[LANDMARKS.LEFT_EYE_TOP], 3);
            drawLandmark(landmarks[LANDMARKS.LEFT_EYE_BOTTOM], 3);
            drawLandmark(landmarks[LANDMARKS.RIGHT_EYE_TOP], 3);
            drawLandmark(landmarks[LANDMARKS.RIGHT_EYE_BOTTOM], 3);
            
            // Áúâ„ÇíÈªÑËâ≤„ÅßË°®Á§∫ÔºàÂÜÖÂÅ¥„Å®Â§ñÂÅ¥Ôºâ
            canvasCtx.fillStyle = '#FFFF00';
            drawLandmark(landmarks[LANDMARKS.LEFT_EYEBROW_INNER], 3);
            drawLandmark(landmarks[LANDMARKS.LEFT_EYEBROW_OUTER], 3);
            drawLandmark(landmarks[LANDMARKS.RIGHT_EYEBROW_INNER], 3);
            drawLandmark(landmarks[LANDMARKS.RIGHT_EYEBROW_OUTER], 3);
        }
        
        function drawLandmark(landmark, size = 3) {
            if (!landmark) return;
            canvasCtx.beginPath();
            canvasCtx.arc(
                landmark.x * canvasElement.width,
                landmark.y * canvasElement.height,
                size, 0, 2 * Math.PI
            );
            canvasCtx.fill();
        }
        
        function getDefaultEmotions() {
            return {
                happy: 0,
                sad: 0,
                angry: 0,
                surprised: 0,
                neutral: 100
            };
        }
        
        async function estimateEmotions(landmarks) {
            // Face-api.js„É¢„Éá„É´„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÂæìÊù•„ÅÆ„É´„Éº„É´„Éô„Éº„ÇπÊé®ÂÆö„Çí‰ΩøÁî®
            if (!faceApiModelsLoaded) {
                return estimateEmotionsRuleBased(landmarks);
            }
            
            // Êó¢„Å´Ê§úÂá∫‰∏≠„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂêë‰∏äÔºâ
            if (isDetectingEmotion) {
                return lastEmotionDetection || getDefaultEmotions();
            }
            
            try {
                isDetectingEmotion = true;
                
                // Face-api.js„ÅßÊÑüÊÉÖ„ÇíÊ§úÂá∫
                const detections = await faceapi
                    .detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions())
                    .withFaceExpressions();
                
                if (detections && detections.expressions) {
                    const expressions = detections.expressions;
                    
                    // Face-api.js„ÅÆ7„Å§„ÅÆÊÑüÊÉÖ„Çí5„Å§„Å´„Éû„ÉÉ„Éî„É≥„Ç∞
                    const emotions = {
                        happy: (expressions.happy || 0) * 100,
                        sad: (expressions.sad || 0) * 100,
                        angry: (expressions.angry || 0) * 100,
                        surprised: (expressions.surprised || 0) * 100,
                        neutral: ((expressions.neutral || 0) + (expressions.disgusted || 0) * 0.3 + (expressions.fearful || 0) * 0.3) * 100
                    };
                    
                    // „Éá„Éê„ÉÉ„Ç∞ÂÄ§„ÇíÊõ¥Êñ∞ÔºàAIÊ§úÂá∫„ÇíÁ§∫„ÅôÔºâ
                    const mouthSmile = (expressions.happy - expressions.sad) * 0.01;
                    const mouthOpen = expressions.surprised * 0.01;
                    document.getElementById('smileValue').textContent = mouthSmile.toFixed(4) + ' (AI)';
                    document.getElementById('mouthOpen').textContent = mouthOpen.toFixed(4) + ' (AI)';
                    
                    // ÊÑüÂ∫¶Ë™øÊï¥„ÇíÈÅ©Áî®
                    const happyMultiplier = happySensitivity / 50;
                    const overallMultiplier = overallSensitivity / 50;
                    
                    emotions.happy *= happyMultiplier;
                    emotions.sad *= overallMultiplier;
                    emotions.angry *= overallMultiplier;
                    emotions.surprised *= overallMultiplier;
                    
                    // Ê≠£Ë¶èÂåñ
                    const total = Object.values(emotions).reduce((a, b) => a + b, 0);
                    if (total > 0) {
                        for (let emotion in emotions) {
                            emotions[emotion] = Math.round((emotions[emotion] / total) * 100);
                        }
                    }
                    
                    lastEmotionDetection = emotions;
                    isDetectingEmotion = false;
                    return emotions;
                }
            } catch (error) {
                console.error('AIÊÑüÊÉÖÊ§úÂá∫„Ç®„É©„Éº:', error);
            }
            
            isDetectingEmotion = false;
            
            // Ê§úÂá∫Â§±ÊïóÊôÇ„ÅØÊúÄÂæå„ÅÆÁµêÊûú„ÇíËøî„Åô„Åã„ÄÅ„É´„Éº„É´„Éô„Éº„Çπ„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            if (lastEmotionDetection) {
                return lastEmotionDetection;
            }
            
            return estimateEmotionsRuleBased(landmarks);
        }
        
        // ÂæìÊù•„ÅÆ„É´„Éº„É´„Éô„Éº„ÇπÊÑüÊÉÖÊé®ÂÆöÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®Ôºâ
        function estimateEmotionsRuleBased(landmarks) {
            const emotions = {
                happy: 0,
                sad: 0,
                angry: 0,
                surprised: 0,
                neutral: 30
            };
            
            try {
                // Âè£Ëßí„ÅÆ‰∏äÊòá„ÇíË®àÁÆóÔºàÂñú„Å≥Ôºâ
                const leftMouth = landmarks[LANDMARKS.LEFT_MOUTH_CORNER];
                const rightMouth = landmarks[LANDMARKS.RIGHT_MOUTH_CORNER];
                const mouthTop = landmarks[LANDMARKS.MOUTH_TOP];
                const mouthBottom = landmarks[LANDMARKS.MOUTH_BOTTOM];
                
                // Âè£Ëßí„ÅÆÂπ≥ÂùáYÂ∫ßÊ®ô
                const mouthCornersY = (leftMouth.y + rightMouth.y) / 2;
                // Âè£„ÅÆ‰∏≠ÂøÉYÂ∫ßÊ®ô
                const mouthCenterY = (mouthTop.y + mouthBottom.y) / 2;
                
                // Âè£Ëßí„Åå‰∏ä„Åå„Å£„Å¶„ÅÑ„ÇãÂ∫¶Âêà„ÅÑÔºàÂÄ§„ÅåÂ∞è„Åï„ÅÑ„Åª„Å©‰∏ä„Åå„Å£„Å¶„ÅÑ„ÇãÔºâ
                const mouthSmile = mouthCenterY - mouthCornersY;
                
                // Âè£„ÅÆÈñã„ÅçÂÖ∑Âêà
                const mouthOpenness = Math.abs(mouthBottom.y - mouthTop.y);
                
                // „Éá„Éê„ÉÉ„Ç∞ÂÄ§Ë°®Á§∫
                document.getElementById('smileValue').textContent = mouthSmile.toFixed(4);
                document.getElementById('mouthOpen').textContent = mouthOpenness.toFixed(4);
                
                // Âñú„Å≥„ÅÆÂà§ÂÆöÔºàË™øÊï¥ÁâàÔºâ
                const happyMultiplier = happySensitivity / 50;
                if (mouthSmile > 0.005) { // ÈñæÂÄ§„Çí‰∏ã„Åí„Åü
                    emotions.happy = Math.min(100, mouthSmile * 3000 * happyMultiplier);
                    
                    // Âè£„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÁ¨ëÈ°î„ÅÆÂèØËÉΩÊÄß„ÅåÈ´ò„ÅÑ
                    if (mouthOpenness > 0.02) {
                        emotions.happy = Math.min(100, emotions.happy * 1.5);
                    }
                }
                
                // ÊÇ≤„Åó„Åø„ÅÆÂà§ÂÆö
                if (mouthSmile < -0.005) {
                    emotions.sad = Math.min(100, Math.abs(mouthSmile) * 2000 * (overallSensitivity / 50));
                }
                
                // ÁúâÈñì„ÅÆË∑ùÈõ¢„Åã„ÇâÊÄí„Çä„ÇíÊé®ÂÆö
                const leftBrow = landmarks[LANDMARKS.LEFT_EYEBROW_INNER];
                const rightBrow = landmarks[LANDMARKS.RIGHT_EYEBROW_INNER];
                const browDistance = Math.abs(leftBrow.x - rightBrow.x);
                
                if (browDistance < 0.08) {
                    emotions.angry = Math.min(100, (0.08 - browDistance) * 1000 * (overallSensitivity / 50));
                }
                
                // ÁõÆ„ÅÆÈñã„ÅçÂÖ∑Âêà„Åã„ÇâÈ©ö„Åç„ÇíÊé®ÂÆö
                const leftEyeOpen = Math.abs(landmarks[LANDMARKS.LEFT_EYE_BOTTOM].y - landmarks[LANDMARKS.LEFT_EYE_TOP].y);
                const rightEyeOpen = Math.abs(landmarks[LANDMARKS.RIGHT_EYE_BOTTOM].y - landmarks[LANDMARKS.RIGHT_EYE_TOP].y);
                const eyeOpenness = (leftEyeOpen + rightEyeOpen) / 2;
                
                if (eyeOpenness > 0.03) {
                    emotions.surprised = Math.min(100, eyeOpenness * 2000 * (overallSensitivity / 50));
                }
                
                // ‰∏≠Á´ã„ÅÆË™øÊï¥
                const totalEmotions = emotions.happy + emotions.sad + emotions.angry + emotions.surprised;
                if (totalEmotions < 50) {
                    emotions.neutral = 100 - totalEmotions;
                } else {
                    emotions.neutral = Math.max(0, 30 - totalEmotions / 3);
                }
                
                // Ê≠£Ë¶èÂåñ
                const total = Object.values(emotions).reduce((a, b) => a + b, 0);
                if (total > 0) {
                    for (let emotion in emotions) {
                        emotions[emotion] = Math.round((emotions[emotion] / total) * 100);
                    }
                }
                
            } catch (error) {
                console.error('ÊÑüÊÉÖÊé®ÂÆö„Ç®„É©„Éº:', error);
            }
            
            return emotions;
        }
        
        function updateEmotionDisplay(emotions) {
            // ÊúÄ„ÇÇÂº∑„ÅÑÊÑüÊÉÖ„ÇíÁâπÂÆö
            let maxEmotion = 'neutral';
            let maxValue = 0;
            
            for (let emotion in emotions) {
                const value = emotions[emotion];
                
                // „Éê„Éº„ÇíÊõ¥Êñ∞
                document.getElementById(`${emotion}-bar`).style.width = value + '%';
                document.getElementById(`${emotion}-value`).textContent = value + '%';
                
                if (value > maxValue) {
                    maxValue = value;
                    maxEmotion = emotion;
                }
            }
            
            // ÁèæÂú®„ÅÆÊÑüÊÉÖ„ÇíË°®Á§∫
            const emojiElement = document.getElementById('currentEmoji');
            const currentEmoji = emotionEmojis[maxEmotion];
            if (emojiElement.textContent !== currentEmoji) {
                emojiElement.textContent = currentEmoji;
                emojiElement.classList.add('pulse');
                setTimeout(() => emojiElement.classList.remove('pulse'), 2000);
            }
            
            document.getElementById('currentEmotion').textContent = emotionNames[maxEmotion];
            document.getElementById('confidence').textContent = maxValue;
        }
        
        function updateStatus(message, type = '') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            
            if (type === 'error') {
                statusElement.classList.add('error');
            } else if (type === 'success') {
                statusElement.classList.add('success');
            } else if (type === 'loading') {
                statusElement.classList.add('loading');
            }
        }
        
        // „Ç≥„É≥„Éà„É≠„Éº„É´Èñ¢Êï∞
        function toggleLandmarks() {
            showLandmarks = !showLandmarks;
            document.getElementById('landmarksToggle').classList.toggle('active');
        }
        
        function toggleMesh() {
            showMesh = !showMesh;
            document.getElementById('meshToggle').classList.toggle('active');
        }
        
        // „Éì„Éá„Ç™Ë°®Á§∫„ÅØÂ∏∏ÊôÇ„Ç™„ÉïÔºàÊèèÁîªË≤†Ëç∑ËªΩÊ∏õ„ÅÆ„Åü„ÇÅ„Ç≠„É£„É≥„Éê„Çπ„ÅÆ„Åø‰ΩøÁî®Ôºâ
        
        // ‰∏ÄÊôÇÂÅúÊ≠¢Ê©üËÉΩ„ÅØÂâäÈô§ÔºàÂ∏∏ÊôÇÂá¶ÁêÜÔºâ
        
        function updateSensitivity(type) {
            if (type === 'happy') {
                happySensitivity = parseInt(document.getElementById('happySensitivity').value);
                document.getElementById('happySensitivity-value').textContent = happySensitivity;
            } else {
                overallSensitivity = parseInt(document.getElementById('overallSensitivity').value);
                document.getElementById('overallSensitivity-value').textContent = overallSensitivity;
            }
        }
    </script>
</body>
</html>
