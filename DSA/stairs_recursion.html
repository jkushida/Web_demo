<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšæ®µå•é¡Œ - æ‰‹å‹•åˆ¶å¾¡å¯èƒ½ãªå†å¸°å¯è¦–åŒ–</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="number"] {
            width: 60px;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        button:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: scale(1);
        }
        
        .step-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #f0f0ff;
            padding: 8px 15px;
            border-radius: 10px;
            margin: 15px 0;
            justify-content: space-between;
        }
        
        .step-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .step-info {
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .step-description {
            font-size: 1em;
            font-weight: bold;
            color: #667eea;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .step-nav-buttons {
            display: flex;
            gap: 5px;
        }
        
        .step-nav-buttons button {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        
        .visualization-container {
            display: grid;
            grid-template-columns: 9fr 5fr;
            gap: 50px;
            margin-top: 30px;
        }
        
        .tree-container {
            background: #f8f9fa;
            padding: 20px 10px;
            border-radius: 10px;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 700px;
            min-height: 500px;
        }
        
        .call-stack-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            max-width: 400px;
        }
        
        h2 {
            color: #667eea;
            margin-top: 0;
        }
        
        .tree {
            display: flex;
            justify-content: flex-start;
            margin: 20px 0;
            padding-left: 20px;
        }
        
        .node {
            display: inline-block;
            text-align: center;
            position: relative;
            margin: 0 10px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .node.visible {
            opacity: 1;
        }
        
        .node-content {
            display: inline-block;
            padding: 8px 12px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin: 5px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        /* çµ‚ç«¯ãƒãƒ¼ãƒ‰ï¼ˆåŸºåº•æ¡ä»¶ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .node-content.terminal {
            border-radius: 0;
            background: #f0f0ff;
            border-width: 3px;
        }
        
        .node-content.terminal.visited {
            background: #90EE90;
            border-color: #4CAF50;
        }
        
        .node-content.terminal.current {
            background: #FFD700;
            border-color: #FFA500;
        }
        
        .node-content:hover {
            background: #f0f0ff;
            transform: scale(1.1);
        }
        
        .node-content.active {
            background: #667eea;
            color: white;
        }
        
        .node-content.visited {
            background: #90EE90;
            border-color: #4CAF50;
        }
        
        .node-content.current {
            background: #FFD700;
            border-color: #FFA500;
            animation: pulse 0.5s infinite;
        }
        
        .node-content.pending {
            background: #FFE4E1;
            border-color: #FF6B6B;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .node-value {
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
        }
        
        .children {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 65px;
            position: relative;
        }
        
        /* è¦ªã‹ã‚‰å­ã¸ã®ç¸¦ç·š */
        .node.visible > .children::before {
            content: '';
            position: absolute;
            top: -65px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 30px;
            background: #667eea;
            transition: opacity 0.3s ease;
        }
        
        /* å­ãƒãƒ¼ãƒ‰é–“ã®æ¨ªç·š */
        .node.visible > .children::after {
            content: '';
            position: absolute;
            top: -30px;
            left: 15%;
            right: 15%;
            height: 2px;
            background: #667eea;
            transition: opacity 0.3s ease;
        }
        
        /* å„å­ãƒãƒ¼ãƒ‰ã¸ã®ç¸¦ç·š */
        .node.visible > .children > .node::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 30px;
            background: #667eea;
        }
        
        /* çµ‚ç«¯ãƒãƒ¼ãƒ‰ã¸ã®ç¸¦ç·š */
        .node.visible > .children > .node.terminal-node::before {
            background: #667eea; /* é’è‰²ã®ç·šã«æˆ»ã™ */
        }
        
        .stack-item {
            background: white;
            border: 2px solid #667eea;
            padding: 8px;
            margin: 3px 0;
            border-radius: 5px;
            transition: all 0.3s;
            font-family: monospace;
            font-size: 14px;
        }
        
        .stack-item.active {
            background: #FFD700;
            border-color: #FFA500;
            font-weight: bold;
        }
        
        .stack-item.completed {
            background: #90EE90;
            border-color: #4CAF50;
            text-decoration: line-through;
        }
        
        
        .info-panel {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        
        .info-panel h3 {
            margin-top: 0;
            color: #856404;
        }
        
        .formula {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
        }
        
        
        .shortcut-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
            border: 1px solid #b3d9ff;
        }
        
        .shortcut-key {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            margin: 0 2px;
        }
        
        @media (max-width: 1024px) {
            .visualization-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸªœ éšæ®µå•é¡Œã®å†å¸°æ¢ç´¢</h1>
        
        <div class="info-panel">
            <h3>å•é¡Œè¨­å®š</h3>
            <p>næ®µã®éšæ®µã‚’1æ®µã¾ãŸã¯2æ®µãšã¤ç™»ã‚‹ã¨ãã®ã€ç™»ã‚Šæ–¹ã®ç·æ•°ã‚’æ±‚ã‚ã¾ã™ã€‚</p>
            <p>å†å¸°å¼: <span class="formula">count(n) = count(n-1) + count(n-2)</span></p>
            <p>åŸºåº•æ¡ä»¶: <span class="formula">count(1) = 1, count(2) = 2</span></p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="stairsInput">éšæ®µã®æ®µæ•° (n):</label>
                <input type="number" id="stairsInput" min="1" max="10" value="5">
            </div>
            
            <button onclick="initializeVisualization()" id="initBtn">
                åˆæœŸåŒ–
            </button>
            
            <button onclick="resetVisualization()" id="resetBtn">
                ãƒªã‚»ãƒƒãƒˆ
            </button>
        </div>
        
        <div class="step-controls" id="stepControls" style="display: none;">
            <div class="step-left">
                <div class="step-info">
                    ã‚¹ãƒ†ãƒƒãƒ—: <span id="currentStep">0</span> / <span id="totalSteps">0</span>
                </div>
                <div class="step-description" id="stepDescription"></div>
            </div>
            <div class="step-nav-buttons">
                <button onclick="firstStep()" id="firstBtn" title="æœ€åˆã¸">
                    â®ï¸
                </button>
                <button onclick="previousStep()" id="prevBtn" title="å‰ã¸">
                    â¬…ï¸
                </button>
                <button onclick="nextStep()" id="nextBtn" title="æ¬¡ã¸">
                    â¡ï¸
                </button>
                <button onclick="lastStep()" id="lastBtn" title="æœ€å¾Œã¸">
                    â­ï¸
                </button>
            </div>
        </div>
        
        <div class="visualization-container">
            <div class="tree-container">
                <h2>å†å¸°å‘¼ã³å‡ºã—ãƒ„ãƒªãƒ¼</h2>
                <div id="treeVisualization"></div>
            </div>
            
            <div class="call-stack-container">
                <h2>ã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯</h2>
                <div id="callStack"></div>
                
                <h3 style="margin-top: 20px;">å®Ÿè¡Œãƒ­ã‚°</h3>
                <div id="executionLog" style="max-height: 180px; overflow-y: auto; background: white; padding: 8px; border-radius: 5px; font-family: monospace; font-size: 14px;"></div>
            </div>
        </div>
        
        <div class="shortcut-info">
            <strong>ğŸ® æ“ä½œæ–¹æ³•:</strong>
            <div style="margin-top: 10px;">
                <strong>ãƒœã‚¿ãƒ³æ“ä½œ:</strong><br>
                â€¢ â®ï¸ æœ€åˆ: æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¸ã‚¸ãƒ£ãƒ³ãƒ—<br>
                â€¢ â¬…ï¸ å‰ã¸: 1ã‚¹ãƒ†ãƒƒãƒ—æˆ»ã‚‹<br>
                â€¢ â¡ï¸ æ¬¡ã¸: 1ã‚¹ãƒ†ãƒƒãƒ—é€²ã‚€<br>
                â€¢ â­ï¸ æœ€å¾Œ: æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¸ã‚¸ãƒ£ãƒ³ãƒ—<br>
            </div>
            <div style="margin-top: 10px;">
                <strong>âŒ¨ï¸ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ:</strong><br>
                <span class="shortcut-key">â†</span> å‰ã®ã‚¹ãƒ†ãƒƒãƒ—
                <span class="shortcut-key">â†’</span> æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
                <span class="shortcut-key">Home</span> æœ€åˆã¸
                <span class="shortcut-key">End</span> æœ€å¾Œã¸
            </div>
        </div>
    </div>
    
    <script>
        // å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ã®è¨˜éŒ²
        let executionSteps = [];
        let currentStepIndex = -1;
        let treeNodes = new Map();
        
        // ã‚¹ãƒ†ãƒƒãƒ—ã®ç¨®é¡
        const STEP_TYPES = {
            CALL: 'call',
            BASE_CASE: 'base_case',
            CALCULATE: 'calculate',
            RETURN: 'return'
        };
        
        class ExecutionStep {
            constructor(type, n, depth, nodeId, result = null, left = null, right = null) {
                this.type = type;
                this.n = n;
                this.depth = depth;
                this.nodeId = nodeId;
                this.result = result;
                this.left = left;
                this.right = right;
                this.stackState = [];
                this.logMessage = '';
            }
        }
        
        // ãƒ„ãƒªãƒ¼ãƒãƒ¼ãƒ‰ã®ä½œæˆï¼ˆå®Œå…¨ãªãƒ„ãƒªãƒ¼æ§‹é€ ã‚’äº‹å‰æ§‹ç¯‰ï¼‰
        let nodeCounter = 0;
        let nodeStructure = new Map(); // ãƒãƒ¼ãƒ‰IDã¨ãã®å­ãƒãƒ¼ãƒ‰IDã®ãƒãƒƒãƒ”ãƒ³ã‚°
        
        function createTreeNode(n, depth = 0, parentId = null, position = '') {
            const nodeId = `node-${n}-${depth}-${position}-${nodeCounter++}`;
            const node = document.createElement('div');
            node.className = 'node';
            node.id = nodeId;
            
            const content = document.createElement('div');
            content.className = 'node-content';
            
            // çµ‚ç«¯ãƒãƒ¼ãƒ‰ï¼ˆåŸºåº•æ¡ä»¶ï¼‰ã«terminalã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            if (n === 1 || n === 2) {
                content.classList.add('terminal');
                content.style.backgroundColor = '#e0e0e0'; // è–„ã„ç°è‰²
                node.classList.add('terminal-node'); // ãƒãƒ¼ãƒ‰è‡ªä½“ã«ã‚‚ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            }
            
            content.innerHTML = `count(${n})`;
            content.dataset.n = n;
            content.dataset.depth = depth;
            content.dataset.nodeId = nodeId;
            
            node.appendChild(content);
            treeNodes.set(nodeId, content);
            
            if (n > 2) {
                const children = document.createElement('div');
                children.className = 'children';
                
                // å·¦ã®å­: count(n-1)ã€å³ã®å­: count(n-2)
                const leftChild = createTreeNode(n - 1, depth + 1, nodeId, position + 'L');
                const rightChild = createTreeNode(n - 2, depth + 1, nodeId, position + 'R');
                
                // ãƒãƒ¼ãƒ‰æ§‹é€ ã‚’è¨˜éŒ²
                nodeStructure.set(nodeId, {
                    left: leftChild.id,
                    right: rightChild.id,
                    n: n
                });
                
                children.appendChild(leftChild);
                children.appendChild(rightChild);
                node.appendChild(children);
            } else {
                // çµ‚ç«¯ãƒãƒ¼ãƒ‰ã‚‚è¨˜éŒ²
                nodeStructure.set(nodeId, {
                    left: null,
                    right: null,
                    n: n
                });
            }
            
            return node;
        }
        
        // å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ã®äº‹å‰è¨ˆç®—
        function computeExecutionSteps(n, depth = 0, nodeId = null, stackState = []) {
            const steps = [];
            
            // å‘¼ã³å‡ºã—ã‚¹ãƒ†ãƒƒãƒ—
            const callStep = new ExecutionStep(STEP_TYPES.CALL, n, depth, nodeId);
            callStep.stackState = [...stackState, `count(${n})`];
            callStep.logMessage = `é–¢æ•°å‘¼ã³å‡ºã—: count(${n}) - æ·±ã•: ${depth}`;
            steps.push(callStep);
            
            let result;
            
            if (n === 1) {
                // åŸºåº•æ¡ä»¶1
                result = 1;
                const baseStep = new ExecutionStep(STEP_TYPES.BASE_CASE, n, depth, nodeId, result);
                baseStep.stackState = [...stackState, `count(${n})`];
                baseStep.logMessage = `åŸºåº•æ¡ä»¶: count(1) = 1`;
                steps.push(baseStep);
            } else if (n === 2) {
                // åŸºåº•æ¡ä»¶2
                result = 2;
                const baseStep = new ExecutionStep(STEP_TYPES.BASE_CASE, n, depth, nodeId, result);
                baseStep.stackState = [...stackState, `count(${n})`];
                baseStep.logMessage = `åŸºåº•æ¡ä»¶: count(2) = 2`;
                steps.push(baseStep);
            } else {
                // å†å¸°å‘¼ã³å‡ºã—
                const newStackState = [...stackState, `count(${n})`];
                
                // nodeStructureã‹ã‚‰å­ãƒãƒ¼ãƒ‰ã®IDã‚’å–å¾—
                const nodeInfo = nodeStructure.get(nodeId);
                const leftNodeId = nodeInfo ? nodeInfo.left : null;
                const rightNodeId = nodeInfo ? nodeInfo.right : null;
                
                console.log(`Computing for count(${n}), nodeId=${nodeId}, left=${leftNodeId}, right=${rightNodeId}`);
                
                // å·¦ã®å­ãƒãƒ¼ãƒ‰ (n-1)
                const leftSteps = computeExecutionSteps(n - 1, depth + 1, leftNodeId, newStackState);
                steps.push(...leftSteps);
                const leftResult = getResultFromSteps(leftSteps);
                
                // å³ã®å­ãƒãƒ¼ãƒ‰ (n-2)
                const rightSteps = computeExecutionSteps(n - 2, depth + 1, rightNodeId, newStackState);
                steps.push(...rightSteps);
                const rightResult = getResultFromSteps(rightSteps);
                
                // è¨ˆç®—ã‚¹ãƒ†ãƒƒãƒ—
                result = leftResult + rightResult;
                const calcStep = new ExecutionStep(STEP_TYPES.CALCULATE, n, depth, nodeId, result, leftResult, rightResult);
                calcStep.stackState = [...stackState, `count(${n})`];
                calcStep.logMessage = `è¨ˆç®—: count(${n}) = count(${n-1}) + count(${n-2}) = ${leftResult} + ${rightResult} = ${result}`;
                steps.push(calcStep);
            }
            
            // æˆ»ã‚Šã‚¹ãƒ†ãƒƒãƒ—
            const returnStep = new ExecutionStep(STEP_TYPES.RETURN, n, depth, nodeId, result);
            returnStep.stackState = [...stackState];
            returnStep.logMessage = `æˆ»ã‚Šå€¤: count(${n}) = ${result}`;
            steps.push(returnStep);
            
            return steps;
        }
        
        function getResultFromSteps(steps) {
            // æœ€å¾Œã®RETURNã‚¹ãƒ†ãƒƒãƒ—ã‚’å–å¾—ï¼ˆè¤‡æ•°ã‚ã‚‹å ´åˆã¯æœ€å¾Œã®ã‚‚ã®ãŒæ­£ã—ã„çµæœï¼‰
            for (let i = steps.length - 1; i >= 0; i--) {
                if (steps[i].type === STEP_TYPES.RETURN) {
                    return steps[i].result;
                }
            }
            return null;
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—ã®è¡¨ç¤º
        function displayStep(stepIndex) {
            if (stepIndex < 0 || stepIndex >= executionSteps.length) return;
            
            const step = executionSteps[stepIndex];
            
            // ãƒ‡ãƒãƒƒã‚°: ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±
            console.log(`Step ${stepIndex}: type=${step.type}, n=${step.n}, nodeId=${step.nodeId}`);
            
            // ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
            treeNodes.forEach((nodeContent, nodeId) => {
                const nodeElement = document.getElementById(nodeId);
                nodeElement.classList.remove('visible');
                nodeContent.classList.remove('current', 'active', 'visited', 'pending');
                const valueDisplay = nodeContent.querySelector('.node-value');
                if (valueDisplay) {
                    valueDisplay.remove();
                }
            });
            
            // ç¾åœ¨ã¾ã§ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å†ç¾
            const nodeResults = new Map(); // å„ãƒãƒ¼ãƒ‰ã®æœ€çµ‚çµæœã‚’è¨˜éŒ²
            const visitedNodes = new Set(); // è¨ªå•æ¸ˆã¿ãƒãƒ¼ãƒ‰ã‚’è¨˜éŒ²
            const processedNodes = new Set(); // å‡¦ç†æ¸ˆã¿ãƒãƒ¼ãƒ‰ã‚’è¨˜éŒ²
            
            for (let i = 0; i <= stepIndex; i++) {
                const s = executionSteps[i];
                if (s.nodeId && treeNodes.has(s.nodeId)) {
                    const node = treeNodes.get(s.nodeId);
                    const nodeElement = document.getElementById(s.nodeId);
                    
                    // ãƒãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                    nodeElement.classList.add('visible');
                    visitedNodes.add(s.nodeId);
                    
                    // ãƒ‡ãƒãƒƒã‚°: count(4)ã®å­ãƒãƒ¼ãƒ‰ã®çŠ¶æ³ã‚’ç¢ºèª
                    if (s.n === 4 && (s.type === STEP_TYPES.CALL || s.type === STEP_TYPES.CALCULATE)) {
                        const nodeInfo = nodeStructure.get(s.nodeId);
                        if (nodeInfo) {
                            console.log(`count(4) at step ${i}: left=${nodeInfo.left}, right=${nodeInfo.right}`);
                            if (nodeInfo.left) {
                                const leftElement = document.getElementById(nodeInfo.left);
                                console.log(`  Left child visible: ${leftElement?.classList.contains('visible')}`);
                            }
                            if (nodeInfo.right) {
                                const rightElement = document.getElementById(nodeInfo.right);
                                console.log(`  Right child visible: ${rightElement?.classList.contains('visible')}`);
                            }
                        }
                    }
                    
                    if (i === stepIndex) {
                        // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—
                        node.classList.add('current');
                    } else if (s.type === STEP_TYPES.RETURN || s.type === STEP_TYPES.BASE_CASE) {
                        // å®Œäº†ã—ãŸãƒãƒ¼ãƒ‰ - æœ€æ–°ã®çµæœã‚’è¨˜éŒ²
                        node.classList.add('visited');
                        nodeResults.set(s.nodeId, s.result);
                        processedNodes.add(s.nodeId);
                    } else if (s.type === STEP_TYPES.CALL && !processedNodes.has(s.nodeId)) {
                        // å‡¦ç†ä¸­ã®ãƒãƒ¼ãƒ‰ï¼ˆã¾ã å®Œäº†ã—ã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
                        node.classList.add('pending');
                    }
                }
            }
            
            // çµæœã®è¡¨ç¤ºï¼ˆé‡è¤‡ã‚’é˜²ããŸã‚æœ€å¾Œã«ä¸€æ‹¬ã§è¡Œã†ï¼‰
            nodeResults.forEach((result, nodeId) => {
                const node = treeNodes.get(nodeId);
                if (node && !node.querySelector('.node-value')) {
                    const valueDisplay = document.createElement('div');
                    valueDisplay.className = 'node-value';
                    valueDisplay.textContent = result;
                    node.appendChild(valueDisplay);
                }
            });
            
            // ã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã®æ›´æ–°
            updateCallStack(step.stackState, step.n);
            
            // ãƒ­ã‚°ã®æ›´æ–°
            updateLog(step.logMessage);
            
            // ã‚¹ãƒ†ãƒƒãƒ—èª¬æ˜ã®æ›´æ–°
            updateStepDescription(step);
            
            // ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ã®æ›´æ–°
            document.getElementById('currentStep').textContent = stepIndex + 1;
            
            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹è¨­å®š
            updateButtonStates();
            
            // æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã§çµæœè¡¨ç¤º
            if (stepIndex === executionSteps.length - 1) {
                console.log(`æœ€çµ‚çµæœ: n=${step.n}, result=${step.result}`);
                
                // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ï¼ˆcount(5)ï¼‰ã«ã‚‚æœ€çµ‚çµæœã‚’è¡¨ç¤º
                const rootNodeId = executionSteps[0].nodeId; // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã®nodeIdãŒãƒ«ãƒ¼ãƒˆ
                if (!nodeResults.has(rootNodeId)) {
                    nodeResults.set(rootNodeId, step.result);
                    const rootNode = treeNodes.get(rootNodeId);
                    if (rootNode && !rootNode.querySelector('.node-value')) {
                        const valueDisplay = document.createElement('div');
                        valueDisplay.className = 'node-value';
                        valueDisplay.textContent = step.result;
                        rootNode.appendChild(valueDisplay);
                    }
                }
            }
        }
        
        function updateCallStack(stackState, currentN) {
            const stackContainer = document.getElementById('callStack');
            stackContainer.innerHTML = '';
            
            stackState.forEach((item, index) => {
                const stackItem = document.createElement('div');
                stackItem.className = 'stack-item';
                stackItem.style.marginLeft = `${index * 20}px`;
                stackItem.textContent = item;
                
                if (index === stackState.length - 1) {
                    stackItem.classList.add('active');
                }
                
                stackContainer.appendChild(stackItem);
            });
        }
        
        function updateLog(message) {
            const logContainer = document.getElementById('executionLog');
            logContainer.innerHTML = '';
            
            // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã¾ã§ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
            for (let i = 0; i <= currentStepIndex && i < executionSteps.length; i++) {
                const logItem = document.createElement('div');
                logItem.style.marginBottom = '3px';
                logItem.style.opacity = i === currentStepIndex ? '1' : '0.85';
                
                const step = executionSteps[i];
                let color = '#333'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²
                
                // ã‚¹ãƒ†ãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è‰²ã‚’è¨­å®š
                switch(step.type) {
                    case STEP_TYPES.CALL:
                        color = '#1A1A80'; // éå¸¸ã«æ¿ƒã„é’ç´«ï¼ˆé–¢æ•°å‘¼ã³å‡ºã—ï¼‰
                        break;
                    case STEP_TYPES.BASE_CASE:
                        color = '#003300'; // éå¸¸ã«æ¿ƒã„ç·‘ï¼ˆåŸºåº•æ¡ä»¶ï¼‰
                        break;
                    case STEP_TYPES.CALCULATE:
                        color = '#B34500'; // ã‚ˆã‚Šæ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆè¨ˆç®—ï¼‰
                        break;
                    case STEP_TYPES.RETURN:
                        color = '#001A4D'; // éå¸¸ã«æ¿ƒã„é’ï¼ˆæˆ»ã‚Šå€¤ï¼‰
                        break;
                }
                
                logItem.style.color = color;
                logItem.style.fontWeight = i === currentStepIndex ? 'bold' : 'normal';
                logItem.innerHTML = `${i + 1}. ${executionSteps[i].logMessage}`;
                logContainer.appendChild(logItem);
            }
            
            // æœ€æ–°ã®ãƒ­ã‚°ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function updateStepDescription(step) {
            const descElement = document.getElementById('stepDescription');
            let description = '';
            
            switch(step.type) {
                case STEP_TYPES.CALL:
                    description = `ğŸ“ é–¢æ•° count(${step.n}) ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™`;
                    break;
                case STEP_TYPES.BASE_CASE:
                    description = `âœ… åŸºåº•æ¡ä»¶ã«åˆ°é”: count(${step.n}) = ${step.result}`;
                    break;
                case STEP_TYPES.CALCULATE:
                    description = `ğŸ§® è¨ˆç®—ä¸­: count(${step.n}) = ${step.left} + ${step.right} = ${step.result}`;
                    break;
                case STEP_TYPES.RETURN:
                    description = `â†©ï¸ æˆ»ã‚Šå€¤: count(${step.n}) = ${step.result}`;
                    break;
            }
            
            descElement.innerHTML = description;
        }
        
        function updateButtonStates() {
            document.getElementById('firstBtn').disabled = currentStepIndex <= 0;
            document.getElementById('prevBtn').disabled = currentStepIndex <= 0;
            document.getElementById('nextBtn').disabled = currentStepIndex >= executionSteps.length - 1;
            document.getElementById('lastBtn').disabled = currentStepIndex >= executionSteps.length - 1;
        }
        
        
        // åˆ¶å¾¡é–¢æ•°
        function initializeVisualization() {
            const n = parseInt(document.getElementById('stairsInput').value);
            if (n < 1 || n > 10) {
                alert('éšæ®µã®æ®µæ•°ã¯1ã‹ã‚‰10ã®é–“ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            resetVisualization();
            
            // ãƒ„ãƒªãƒ¼ã‚’ä½œæˆ
            const treeContainer = document.getElementById('treeVisualization');
            const tree = createTreeNode(n);
            treeContainer.appendChild(tree);
            
            // ãƒ‡ãƒãƒƒã‚°: ãƒ„ãƒªãƒ¼æ§‹é€ ã‚’ç¢ºèª
            console.log("=== Tree Structure Created ===");
            console.log("Total nodes in treeNodes Map:", treeNodes.size);
            console.log("Total nodes in nodeStructure Map:", nodeStructure.size);
            nodeStructure.forEach((info, nodeId) => {
                console.log(`Node ${nodeId}: n=${info.n}, left=${info.left}, right=${info.right}`);
            });
            
            // å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ã‚’è¨ˆç®—
            const rootNode = tree;
            executionSteps = computeExecutionSteps(n, 0, rootNode.id, []);
            
            console.log("=== Execution Steps Created ===");
            console.log("Total steps:", executionSteps.length);
            // count(4)ã«é–¢é€£ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¢ºèª
            const count4Steps = executionSteps.filter(s => s.n === 4);
            console.log(`Steps for count(4): ${count4Steps.length}`);
            count4Steps.forEach((s, i) => {
                console.log(`  ${i}: type=${s.type}, nodeId=${s.nodeId}, result=${s.result}`);
            });
            
            // UIã‚’æ›´æ–°
            document.getElementById('totalSteps').textContent = executionSteps.length;
            document.getElementById('stepControls').style.display = 'flex';
            document.getElementById('initBtn').disabled = true;
            document.getElementById('stairsInput').disabled = true;
            
            // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤ºï¼ˆæ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ï¼‰
            currentStepIndex = 0;
            displayStep(currentStepIndex);
        }
        
        function resetVisualization() {
            executionSteps = [];
            currentStepIndex = -1;
            treeNodes.clear();
            nodeStructure.clear();  // nodeStructureã‚‚ã‚¯ãƒªã‚¢
            nodeCounter = 0;  // nodeCounterã‚‚ãƒªã‚»ãƒƒãƒˆ
            
            document.getElementById('treeVisualization').innerHTML = '';
            document.getElementById('callStack').innerHTML = '';
            document.getElementById('executionLog').innerHTML = '';
            document.getElementById('stepControls').style.display = 'none';
            document.getElementById('initBtn').disabled = false;
            document.getElementById('stairsInput').disabled = false;
        }
        
        function nextStep() {
            if (currentStepIndex < executionSteps.length - 1) {
                currentStepIndex++;
                displayStep(currentStepIndex);
            }
        }
        
        function previousStep() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                displayStep(currentStepIndex);
            }
        }
        
        function firstStep() {
            currentStepIndex = 0;
            displayStep(currentStepIndex);
        }
        
        function lastStep() {
            currentStepIndex = executionSteps.length - 1;
            displayStep(currentStepIndex);
        }
        
// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            if (executionSteps.length === 0) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    previousStep();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextStep();
                    break;
                case 'Home':
                    e.preventDefault();
                    firstStep();
                    break;
                case 'End':
                    e.preventDefault();
                    lastStep();
                    break;
            }
        });
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨: éšæ®µå•é¡Œã®ç­”ãˆã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
        function calculateStairs(n) {
            if (n === 1) return 1;
            if (n === 2) return 2;
            return calculateStairs(n - 1) + calculateStairs(n - 2);
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            resetVisualization();
            
            // ãƒ‡ãƒãƒƒã‚°: æ­£ã—ã„ç­”ãˆã‚’ç¢ºèª
            console.log("éšæ®µå•é¡Œã®æ­£è§£:");
            for (let i = 1; i <= 5; i++) {
                console.log(`count(${i}) = ${calculateStairs(i)}`);
            }
            // æœŸå¾…ã•ã‚Œã‚‹çµæœ:
            // count(1) = 1
            // count(2) = 2
            // count(3) = 3
            // count(4) = 5
            // count(5) = 8
        });
    </script>
</body>
</html>